import{a as it,b as nt,c as st,d as ot,e as rt,f as at,g as ct,h as lt,i as dt,j as ht}from"./chunk-RAE3MU4N.js";import{$ as w,D as b,G as g,I as W,J as c,K as h,L as k,M as C,N as f,O as u,P as Y,Q as A,R,S as L,T as x,U as B,V as E,W as I,X as M,Y as T,aa as Z,c as O,ja as Q,ka as J,l as p,la as K,m as v,n as S,o as X,pa as $,r as j,sa as tt,ta as et,u as q,v as H,w as l,y as z,z as U}from"./chunk-5QHLOJZU.js";var _t=["videoElement"],Pt=["canvasElement"],yt=["toggleButton"],Ct=["controlsPanel"],wt=(r,e)=>({"bg-gray-900":r,"bg-gray-100":e}),ut=(r,e)=>({"bg-gray-800 text-white":r,"bg-white text-black shadow-lg":e}),bt=(r,e)=>({"bg-gray-700 hover:bg-gray-600 text-white":r,"bg-gray-200 hover:bg-gray-300 text-black":e}),Et=(r,e)=>({"bg-purple-600 hover:bg-purple-700 text-white":r,"bg-green-600 hover:bg-green-700 text-white":e}),It=(r,e)=>({"bg-gray-600 hover:bg-gray-500":r,"bg-gray-300 hover:bg-gray-400":e}),Mt=(r,e,t,n,i,s)=>({"bg-gray-600":r,"bg-gray-700":e,"bg-gray-800":t,"bg-blue-200":n,"bg-gray-200":i,"bg-white":s}),G=(r,e)=>({"bg-gray-700 border border-gray-600":r,"bg-gray-200 border border-gray-300":e});function Tt(r,e){r&1&&(S(),c(0,"svg",11),k(1,"path",12),h())}function kt(r,e){r&1&&(S(),c(0,"svg",11),k(1,"path",13),h())}function Vt(r,e){if(r&1){let t=C();c(0,"div")(1,"label",33)(2,"input",39),T("ngModelChange",function(i){p(t);let s=u(2).$implicit;return M(s.isAnchored,i)||(s.isAnchored=i),v(i)}),f("ngModelChange",function(){p(t);let i=u(2).$implicit,s=u(3);return v(s.toggleAnchor(i))}),h(),c(3,"span"),x(4,"Anclar al Horizonte"),h()()()}if(r&2){let t=u(2).$implicit;l(2),I("ngModel",t.isAnchored)}}function St(r,e){if(r&1){let t=C();c(0,"div")(1,"div",18)(2,"label",40),x(3),h(),c(4,"input",41),T("ngModelChange",function(i){p(t);let s=u(2).$implicit;return M(s.curvature,i)||(s.curvature=i),v(i)}),h()()()}if(r&2){let t=u(2).$implicit;l(2),Y("for","curvature-",t.id,""),l(),E("Curvatura: ",t.curvature,""),l(),Y("id","curvature-",t.id,""),I("ngModel",t.curvature)}}function Ft(r,e){if(r&1&&(c(0,"div",37),b(1,Vt,5,1,"div",38)(2,St,5,6,"div",38),h()),r&2){let t=u().$implicit;l(),g("ngIf",t.pairId===null),l(),g("ngIf",t.pairId!==null)}}function Dt(r,e){if(r&1){let t=C();c(0,"div",31),f("click",function(){let i=p(t).$implicit,s=u(3);return v(s.selectPoint(i.id))}),c(1,"div",32)(2,"div",33)(3,"input",34),T("ngModelChange",function(i){let s=p(t).$implicit;return M(s.color,i)||(s.color=i),v(i)}),f("click",function(i){return p(t),v(i.stopPropagation())}),h(),c(4,"span"),x(5),h()(),c(6,"button",35),f("click",function(i){let s=p(t).$implicit;return u(3).removePerspectivePoint(s.id),v(i.stopPropagation())}),S(),c(7,"svg",25),k(8,"path",13),h()()(),b(9,Ft,3,2,"div",36),h()}if(r&2){let t=e.$implicit,n=e.index,i=u(3);g("ngClass",Z(4,Mt,i.selectedPointId===t.id&&i.theme==="dark",i.selectedPointId!==t.id&&i.selectedPointId!==null&&i.theme==="dark",i.selectedPointId===null&&i.theme==="dark",i.selectedPointId===t.id&&i.theme==="light",i.selectedPointId!==t.id&&i.selectedPointId!==null&&i.theme==="light",i.selectedPointId===null&&i.theme==="light")),l(3),I("ngModel",t.color),l(2),E("Punto ",n+1,""),l(4),g("ngIf",i.selectedPointId===t.id)}}function At(r,e){if(r&1){let t=C();c(0,"div",18)(1,"div",22)(2,"label",23),x(3,"Puntos de Perspectiva"),h(),c(4,"div")(5,"button",24),f("click",function(){p(t);let i=u(2);return v(i.addPerspectivePoint())}),S(),c(6,"svg",25),k(7,"path",26),h()()()(),b(8,Dt,10,11,"div",27),X(),k(9,"hr",28),c(10,"button",29),f("click",function(){p(t);let i=u(2);return v(i.addHorizonVPPair())}),x(11," A\xF1adir par de PV en horizonte "),h(),c(12,"button",30),f("click",function(){p(t);let i=u(2);return v(i.addPerpendicularVPPair())}),x(13," A\xF1adir par de PV perpendicular "),h()()}if(r&2){let t=u(2);l(8),g("ngForOf",t.vanishingPoints)}}function Rt(r,e){if(r&1){let t=C();c(0,"div",18)(1,"label",42),x(2),h(),c(3,"input",43),T("ngModelChange",function(i){p(t);let s=u(2);return M(s.horizonRotation,i)||(s.horizonRotation=i),v(i)}),h()()}if(r&2){let t=u(2);l(2),E("Rotaci\xF3n del Horizonte: ",t.horizonRotation,"\xB0"),l(),I("ngModel",t.horizonRotation)}}function Lt(r,e){if(r&1){let t=C();c(0,"div",18)(1,"label",44),x(2),h(),c(3,"input",45),T("ngModelChange",function(i){p(t);let s=u(2);return M(s.lineCount,i)||(s.lineCount=i),v(i)}),h(),c(4,"div",46)(5,"button",47),f("click",function(){p(t);let i=u(2);return v(i.toggleParallelLines())}),x(6," Paralelas "),h(),c(7,"button",48),f("click",function(){p(t);let i=u(2);return v(i.togglePerpendicularLines())}),x(8," Perpendiculares "),h()()()}if(r&2){let t=u(2);l(2),E("Cantidad de L\xEDneas: ",t.lineCount,""),l(),I("ngModel",t.lineCount),l(2),W("bg-sky-700",t.drawParallel),l(2),W("bg-teal-700",t.drawPerpendicular)}}function Wt(r,e){if(r&1&&(c(0,"option",57),x(1),h()),r&2){let t=e.$implicit;g("value",t.value),l(),B(t.name)}}function Gt(r,e){if(r&1){let t=C();c(0,"div",32)(1,"input",58),T("ngModelChange",function(i){p(t);let s=u(3);return M(s.customAspectRatioWidth,i)||(s.customAspectRatioWidth=i),v(i)}),h(),c(2,"span"),x(3,":"),h(),c(4,"input",59),T("ngModelChange",function(i){p(t);let s=u(3);return M(s.customAspectRatioHeight,i)||(s.customAspectRatioHeight=i),v(i)}),h()()}if(r&2){let t=u(3);l(),I("ngModel",t.customAspectRatioWidth),g("ngClass",w(4,G,t.theme==="dark",t.theme==="light")),l(3),I("ngModel",t.customAspectRatioHeight),g("ngClass",w(7,G,t.theme==="dark",t.theme==="light"))}}function Ot(r,e){if(r&1){let t=C();c(0,"div",18)(1,"h4",49),x(2,"Superposici\xF3n de Marco"),h(),c(3,"div",50)(4,"label",51),x(5,"Relaci\xF3n de Aspecto"),h(),c(6,"select",52),T("ngModelChange",function(i){p(t);let s=u(2);return M(s.selectedAspectRatio,i)||(s.selectedAspectRatio=i),v(i)}),f("ngModelChange",function(){p(t);let i=u(2);return v(i.onAspectRatioChange())}),b(7,Wt,2,2,"option",53),h()(),b(8,Gt,5,10,"div",54),c(9,"div",55)(10,"button",56),f("click",function(){p(t);let i=u(2);return v(i.recordFrame())}),x(11),h()()()}if(r&2){let t=u(2);l(6),I("ngModel",t.selectedAspectRatio),g("ngClass",w(5,G,t.theme==="dark",t.theme==="light")),l(),g("ngForOf",t.aspectRatios),l(),g("ngIf",t.selectedAspectRatio==="custom"),l(3),E(" ",t.selectedAspectRatio!=="none"?"Grabar Marco":"Grabar Pantalla"," ")}}function Xt(r,e){if(r&1&&(c(0,"option",57),x(1),h()),r&2){let t=e.$implicit;g("value",t.deviceId),l(),B(t.label)}}function Ht(r,e){if(r&1){let t=C();c(0,"div",18)(1,"label",60),x(2,"Seleccionar C\xE1mara"),h(),c(3,"select",61),f("change",function(i){p(t);let s=u(2);return v(s.onCameraChange(i))}),b(4,Xt,2,2,"option",53),h()()}if(r&2){let t=u(2);l(3),g("value",t.selectedDeviceId)("ngClass",w(3,G,t.theme==="dark",t.theme==="light")),l(),g("ngForOf",t.videoDevices)}}function zt(r,e){if(r&1){let t=C();c(0,"div",14,3)(2,"button",15),S(),c(3,"svg",16),k(4,"path",17),h(),X(),c(5,"span"),x(6,"Men\xFA/Asistente de Perspectiva"),h()(),c(7,"div",18)(8,"button",19),f("click",function(){p(t);let i=u();return v(i.toggleMode())}),x(9),h()(),b(10,At,14,1,"div",20)(11,Rt,4,2,"div",20)(12,Lt,9,6,"div",20)(13,Ot,12,8,"div",20)(14,Ht,5,6,"div",20),c(15,"button",21),f("click",function(){p(t);let i=u();return v(i.toggleCamera())}),x(16),h(),c(17,"button",19),f("click",function(){p(t);let i=u();return v(i.toggleTheme())}),x(18),h()()}if(r&2){let t=u();g("ngClass",w(12,ut,t.theme==="dark",t.theme==="light")),l(2),g("ngClass",w(15,bt,t.theme==="dark",t.theme==="light")),l(6),g("ngClass",w(18,Et,t.mode==="Edition",t.mode==="Production")),l(),E(" ",t.mode==="Edition"?"Pasar a Modo Producci\xF3n":"Volver a Modo Edici\xF3n"," "),l(),g("ngIf",t.mode==="Edition"),l(),g("ngIf",t.mode==="Edition"),l(),g("ngIf",t.mode==="Edition"),l(),g("ngIf",t.mode==="Edition"),l(),g("ngIf",t.videoDevices.length>1&&t.mode==="Edition"),l(2),E(" ",t.showCamera?"Ocultar":"Mostrar"," C\xE1mara "),l(),g("ngClass",w(21,It,t.theme==="dark",t.theme==="light")),l(),E(" Cambiar a Tema ",t.theme==="dark"?"Claro":"Oscuro"," ")}}var mt=class r{constructor(e,t){this.elementRef=e;this.router=t}gridControlsCollapsed=!1;theme="dark";videoElement;canvasElement;toggleButton;controlsPanel;MIN_SCALE=.1;MAX_SCALE=20;SCALE_AMOUNT=1.1;HANDLE_SIZE=10;TOUCH_HANDLE_SIZE=20;mode="Edition";productionPoint=null;isInteractingWithCanvas=!1;_horizonLevel=0;_horizonRotation=0;lineCount=10;showCamera=!0;drawParallel=!1;drawPerpendicular=!1;aspectRatios=[{name:"None",value:"none"},{name:"1:1",value:"1/1"},{name:"16:9",value:"16/9"},{name:"9:16",value:"9/16"},{name:"4:3",value:"4/3"},{name:"3:2",value:"3/2"},{name:"Custom",value:"custom"}];selectedAspectRatio="none";customAspectRatioWidth=16;customAspectRatioHeight=9;scale=1;panX=0;panY=0;isPanning=!1;lastPanPosition={x:0,y:0};initialPinchDistance=0;isDraggingFrame=!1;lastFrameDragPosition={x:0,y:0};videoDevices=[];selectedDeviceId="";get horizonRotation(){return this._horizonRotation}set horizonRotation(e){this._horizonRotation!==e&&(this._horizonRotation=e,this.updateConstrainedPointsPosition())}ctx;videoStream;vanishingPoints=[];framePoints=[];draggingPointIndex=-1;draggingFramePointIndex=-1;nextPointId=0;nextPairId=0;selectedPointId=null;ngAfterViewInit(){let e=this.canvasElement.nativeElement;this.ctx=e.getContext("2d"),this.setupCanvas(),this.getVideoDevices().then(()=>{this.startCamera()}),this.initVanishingPoints(),this.initFramePoints(),this.draw(),e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("mouseup",this.onMouseUp.bind(this)),e.addEventListener("wheel",this.onWheel.bind(this)),e.addEventListener("touchstart",this.onTouchStart.bind(this)),e.addEventListener("touchmove",this.onTouchMove.bind(this)),e.addEventListener("touchend",this.onTouchEnd.bind(this))}onDocumentInteraction(e){if(this.gridControlsCollapsed)return;let t=e.target;this.toggleButton?.nativeElement.contains(t)||this.controlsPanel&&!this.controlsPanel.nativeElement.contains(t)&&(this.gridControlsCollapsed=!0)}onResize(){this.setupCanvas()}screenToWorld(e,t){return{x:(e-this.panX)/this.scale,y:(t-this.panY)/this.scale}}setupCanvas(){let e=this.canvasElement.nativeElement;e.width=e.offsetWidth,e.height=e.offsetHeight,this._horizonLevel=e.height/2,this.panX=e.width/2,this.panY=this._horizonLevel}getVideoDevices(){return O(this,null,function*(){if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)try{let e=yield navigator.mediaDevices.enumerateDevices();if(this.videoDevices=e.filter(t=>t.kind==="videoinput"),this.videoDevices.length>0){let t=this.videoDevices.find(n=>n.label.toLowerCase().includes("back")||n.label.toLowerCase().includes("rear"));t?this.selectedDeviceId=t.deviceId:this.selectedDeviceId=this.videoDevices[0].deviceId}}catch(e){console.error("Error enumerating devices: ",e)}})}startCamera(e){return O(this,null,function*(){if(this.videoStream&&this.videoStream.getTracks().forEach(t=>t.stop()),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{let t={video:{}};if(e?t.video.deviceId={exact:e}:t.video.facingMode="environment",this.videoStream=yield navigator.mediaDevices.getUserMedia(t),this.videoElement.nativeElement.srcObject=this.videoStream,this.videoElement.nativeElement.play(),!e){let i=this.videoStream.getVideoTracks()[0].getSettings();i.deviceId&&(this.selectedDeviceId=i.deviceId,this.videoDevices.find(o=>o.deviceId===this.selectedDeviceId)||(yield this.getVideoDevices()))}}catch(t){if(console.error("Error accessing camera: ",t),t instanceof DOMException&&(t.name==="OverconstrainedError"||t.name==="NotFoundError"))try{let n={video:!0};this.videoStream=yield navigator.mediaDevices.getUserMedia(n),this.videoElement.nativeElement.srcObject=this.videoStream,this.videoElement.nativeElement.play();let s=this.videoStream.getVideoTracks()[0].getSettings();s.deviceId&&(this.selectedDeviceId=s.deviceId)}catch(n){console.error("Error accessing fallback camera: ",n),this.showCamera=!1}else this.showCamera=!1}})}onCameraChange(e){let t=e.target.value;this.selectedDeviceId=t,this.startCamera(t)}initVanishingPoints(){if(this.vanishingPoints.length===0){let e={id:this.nextPointId++,x:0,y:0,color:this.getRandomColor(),isAnchored:!0,initialXOffset:0,pairId:null,curvature:.5};this.vanishingPoints.push(e),this.selectPoint(e.id)}}initFramePoints(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.screenToWorld(e/2,t/2),i=e/2/this.scale,s=t/2/this.scale;this.framePoints=[{x:n.x-i/2,y:n.y-s/2},{x:n.x+i/2,y:n.y-s/2},{x:n.x+i/2,y:n.y+s/2},{x:n.x-i/2,y:n.y+s/2}]}getRandomColor(){let e="0123456789ABCDEF",t="#";for(let n=0;n<6;n++)t+=e[Math.floor(Math.random()*16)];return t}addPerspectivePoint(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.screenToWorld(e/2,t/2),i={id:this.nextPointId++,x:n.x,y:n.y,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:null,curvature:.5};this.vanishingPoints.push(i),this.selectPoint(i.id)}addHorizonVPPair(){let{width:e}=this.canvasElement.nativeElement,t=this.nextPairId++,n={x:0,y:0},i=-e*.25,s=e*.25,o={id:this.nextPointId++,x:n.x+i,y:n.y,color:this.getRandomColor(),isAnchored:!0,initialXOffset:i,pairId:t,curvature:.5},m={id:this.nextPointId++,x:n.x+s,y:n.y,color:this.getRandomColor(),isAnchored:!0,initialXOffset:s,pairId:t,curvature:.5};this.vanishingPoints.push(o,m),this.updateConstrainedPointsPosition(),this.selectPoint(o.id)}addPerpendicularVPPair(){let e=this.nextPairId++,t={x:0,y:0},n=-200,i=200,s={id:this.nextPointId++,x:t.x,y:t.y+n,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:e,curvature:.5,isPerpendicular:!0,perpendicularOffset:n},o={id:this.nextPointId++,x:t.x,y:t.y+i,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:e,curvature:.5,isPerpendicular:!0,perpendicularOffset:i};this.vanishingPoints.push(s,o),this.updateConstrainedPointsPosition(),this.selectPoint(s.id)}removePerspectivePoint(e){let t=this.vanishingPoints.find(n=>n.id===e);t&&(t.pairId!==null?this.vanishingPoints=this.vanishingPoints.filter(n=>n.pairId!==t.pairId):this.vanishingPoints=this.vanishingPoints.filter(n=>n.id!==e),(this.selectedPointId===e||t.pairId!==null&&this.vanishingPoints.every(n=>n.pairId!==t.pairId))&&(this.selectedPointId=null))}onAspectRatioChange(){if(this.selectedAspectRatio==="none"){this.framePoints=[];return}let e;if(this.selectedAspectRatio==="custom")if(this.customAspectRatioWidth>0&&this.customAspectRatioHeight>0)e=this.customAspectRatioWidth/this.customAspectRatioHeight;else return;else{let m=this.selectedAspectRatio.split("/").map(Number);e=m[0]/m[1]}let{width:t,height:n}=this.canvasElement.nativeElement,i=this.screenToWorld(t/2,n/2),s=300/this.scale,o=s/e;this.framePoints=[{x:i.x-s/2,y:i.y-o/2},{x:i.x+s/2,y:i.y-o/2},{x:i.x+s/2,y:i.y+o/2},{x:i.x-s/2,y:i.y+o/2}]}selectPoint(e){this.mode!=="Production"&&(this.selectedPointId===e?this.selectedPointId=null:this.selectedPointId=e)}toggleAnchor(e){let t={x:0,y:0};e.isAnchored?(e.initialXOffset=e.x-t.x,this.updateConstrainedPointsPosition()):e.initialXOffset=null}updateConstrainedPointsPosition(){let e={x:0,y:0},t=this.horizonRotation*Math.PI/180;this.vanishingPoints.forEach(n=>{n.isAnchored&&n.initialXOffset!==null?(n.x=e.x+n.initialXOffset*Math.cos(t),n.y=e.y+n.initialXOffset*Math.sin(t)):n.isPerpendicular&&n.perpendicularOffset!=null&&(n.x=e.x+n.perpendicularOffset*Math.sin(t),n.y=e.y-n.perpendicularOffset*Math.cos(t))})}toggleMode(){this.mode=this.mode==="Edition"?"Production":"Edition",this.productionPoint=null,this.selectedPointId=null}onCanvasClick(e){this.mode==="Production"&&(this.productionPoint=this.screenToWorld(e.offsetX,e.offsetY))}drawLinesThroughPoint(e){this.vanishingPoints.filter(i=>i.pairId===null).forEach(i=>{this.drawLinesFromPointToPoint(e,i)});let{pairs:n}=this.getVanishingPointPairs();n.forEach(i=>{i.length===2&&this.drawGeodesicLinesFromPoint(e,i[0],i[1])}),this.drawParallel&&this.drawParallelLines(e),this.drawPerpendicular&&this.drawPerpendicularLines(e)}draw(){requestAnimationFrame(()=>this.draw()),this.drawGrid()}hasFrame(){return this.selectedAspectRatio!=="none"&&this.framePoints.length===4}drawPerspectiveFrame(){if(this.hasFrame()){this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=2/this.scale,this.ctx.beginPath(),this.ctx.moveTo(this.framePoints[0].x,this.framePoints[0].y);for(let e=1;e<=this.framePoints.length;e++)this.ctx.lineTo(this.framePoints[e%this.framePoints.length].x,this.framePoints[e%this.framePoints.length].y);this.ctx.stroke(),this.mode==="Edition"&&this.framePoints.forEach(e=>{this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,this.HANDLE_SIZE*.8/this.scale,0,Math.PI*2),this.ctx.fill()})}}drawFrameOverlay(){if(!this.hasFrame())return;let e=this.canvasElement.nativeElement,{width:t,height:n}=e,i=this.framePoints.map(s=>({x:s.x*this.scale+this.panX,y:s.y*this.scale+this.panY}));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(t,0),this.ctx.lineTo(t,n),this.ctx.lineTo(0,n),this.ctx.closePath(),this.ctx.moveTo(i[0].x,i[0].y);for(let s=1;s<i.length;s++)this.ctx.lineTo(i[s].x,i[s].y);this.ctx.closePath(),this.ctx.fill("evenodd"),this.ctx.restore()}isPointInFrame(e){if(this.framePoints.length!==4)return!1;let t=this.framePoints[0],n=this.framePoints[1],i=this.framePoints[2],s=this.framePoints[3],o=(n.x-t.x)*(e.y-t.y)-(n.y-t.y)*(e.x-t.x),m=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),a=(s.x-i.x)*(e.y-i.y)-(s.y-i.y)*(e.x-i.x),d=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x),P=o<0||m<0||a<0||d<0,y=o>0||m>0||a>0||d>0;return!(P&&y)}getFrameImageDataUrl(){if(!this.hasFrame())return null;let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return console.error("Could not create output canvas context"),null;let n=this.framePoints.map(_=>({x:_.x*this.scale+this.panX,y:_.y*this.scale+this.panY})),i=n.map(_=>_.x),s=n.map(_=>_.y),o=Math.min(...i),m=Math.min(...s),a=Math.max(...i),d=Math.max(...s),P=a-o,y=d-m;e.width=P,e.height=y,t.beginPath(),t.moveTo(n[0].x-o,n[0].y-m);for(let _=1;_<n.length;_++)t.lineTo(n[_].x-o,n[_].y-m);return t.closePath(),t.clip(),t.drawImage(this.canvasElement.nativeElement,-o,-m),e.toDataURL("image/png")}recordFrame(){let e;if(this.selectedAspectRatio!=="none"?e=this.getFrameImageDataUrl():e=this.canvasElement.nativeElement.toDataURL("image/png"),e){let t=document.createElement("a");t.href=e,t.download="perspective-drawing.png",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}drawGrid(){let{width:e,height:t}=this.canvasElement.nativeElement;if(this.ctx.clearRect(0,0,e,t),this.showCamera&&this.videoElement.nativeElement.readyState===4&&this.ctx.drawImage(this.videoElement.nativeElement,0,0,e,t),this.ctx.save(),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.scale,this.scale),this.drawHorizonAndPerpendicularAxis(),this.drawVanishingPoints(),this.hasFrame()&&this.drawPerspectiveFrame(),this.mode==="Edition"){this.drawParallel&&this.drawParallelLines(),this.drawPerpendicular&&this.drawPerpendicularLines(),this.vanishingPoints.filter(s=>s.pairId===null).forEach(s=>this.drawLinesToPoint(s));let{pairs:i}=this.getVanishingPointPairs();i.forEach(s=>{s.length===2&&this.drawGeodesicGrid(s[0],s[1])})}else this.mode==="Production"&&this.productionPoint&&this.drawLinesThroughPoint(this.productionPoint);this.ctx.restore(),this.drawFrameOverlay()}drawHorizonAndPerpendicularAxis(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.horizonRotation*Math.PI/180;this.ctx.save(),this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2/this.scale,this.ctx.rotate(n),this.ctx.beginPath();let i=e/this.scale;this.ctx.moveTo(-i*4,0),this.ctx.lineTo(i*4,0),this.ctx.stroke(),this.ctx.restore();let{perpendicularPairs:s}=this.getVanishingPointPairs();if(s.size>0){this.ctx.save(),this.ctx.strokeStyle="#FF00FF",this.ctx.lineWidth=1/this.scale,this.ctx.globalAlpha=.5,this.ctx.rotate(n),this.ctx.beginPath();let o=t/this.scale;this.ctx.moveTo(0,-o*4),this.ctx.lineTo(0,o*4),this.ctx.stroke(),this.ctx.restore()}}getVanishingPointPairs(){let e=new Map,t=new Map;return this.vanishingPoints.forEach(n=>{n.pairId!==null&&(e.has(n.pairId)||e.set(n.pairId,[]),e.get(n.pairId).push(n),n.isPerpendicular&&(t.has(n.pairId)||t.set(n.pairId,[]),t.get(n.pairId).push(n)))}),{pairs:e,perpendicularPairs:t}}drawLinesToPoint(e){let{width:t,height:n}=this.canvasElement.nativeElement;this.ctx.strokeStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id?"gray":e.color,this.ctx.lineWidth=1/this.scale;let i=[this.screenToWorld(0,0),this.screenToWorld(t,0),this.screenToWorld(t,n),this.screenToWorld(0,n)];for(let s=0;s<i.length;s++){let o=i[s],m=i[(s+1)%i.length];for(let a=0;a<=this.lineCount;a++){let d=a/this.lineCount,P=o.x+(m.x-o.x)*d,y=o.y+(m.y-o.y)*d;this.ctx.beginPath(),this.ctx.moveTo(P,y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}}}drawLinesFromPointToPoint(e,t){this.ctx.strokeStyle=t.color||"gray",this.ctx.lineWidth=1/this.scale,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke()}drawGeodesicGrid(e,t){this.ctx.strokeStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id&&this.selectedPointId!==t.id?"gray":e.color,this.ctx.lineWidth=1/this.scale;let n=t.x-e.x,i=t.y-e.y,s=Math.sqrt(n*n+i*i),o=-i/s,m=n/s;for(let a=0;a<=this.lineCount;a++){let d=(a-this.lineCount/2)/(this.lineCount/2),P=e.curvature*s*.5,y=e.x+n*.25+o*P*d,_=e.y+i*.25+m*P*d,F=e.x+n*.75+o*P*d,D=e.y+i*.75+m*P*d;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.bezierCurveTo(y,_,F,D,t.x,t.y),this.ctx.stroke()}}drawGeodesicLinesFromPoint(e,t,n){this.ctx.strokeStyle=t.color,this.ctx.lineWidth=1/this.scale;let i=n.x-t.x,s=n.y-t.y,o=i*i+s*s;if(o===0)return;let m=Math.sqrt(o),a=t.curvature*m*.5;if(a===0)return;let d=((e.x-t.x)*i+(e.y-t.y)*s)/o;d=Math.max(0,Math.min(1,d));let P=d*(.75+d*(.75-.5*d)),y=t.x+P*i,_=t.y+P*s,F=-s/m,D=i/m,gt=(e.x-y)*F+(e.y-_)*D,V,N=3*d*(1-d)*a;Math.abs(N)<1e-6?V=0:V=gt/N;let pt=t.x+i*.25+F*a*V,vt=t.y+s*.25+D*a*V,xt=t.x+i*.75+F*a*V,ft=t.y+s*.75+D*a*V;this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.bezierCurveTo(pt,vt,xt,ft,n.x,n.y),this.ctx.stroke()}drawVanishingPoints(){this.vanishingPoints.forEach(e=>{this.ctx.fillStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id?"gray":e.color,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,this.HANDLE_SIZE/this.scale,0,Math.PI*2),this.ctx.fill(),this.mode==="Edition"&&this.selectedPointId===e.id&&(this.ctx.strokeStyle="white",this.ctx.lineWidth=2/this.scale,this.ctx.stroke())})}onMouseDown(e){if(this.mode==="Production")return;if(e.button===1){this.isPanning=!0,this.lastPanPosition={x:e.clientX,y:e.clientY},this.canvasElement.nativeElement.classList.add("panning"),e.preventDefault();return}let t=this.screenToWorld(e.offsetX,e.offsetY);if(this.isInteractingWithCanvas=!0,this.selectedAspectRatio!=="none"){for(let i=0;i<this.framePoints.length;i++){let s=this.framePoints[i];if(Math.sqrt(Math.pow(s.x-t.x,2)+Math.pow(s.y-t.y,2))<this.HANDLE_SIZE/this.scale){this.draggingFramePointIndex=i,this.canvasElement.nativeElement.classList.add("dragging");return}}if(this.isPointInFrame(t)){this.isDraggingFrame=!0,this.lastFrameDragPosition=t,this.canvasElement.nativeElement.classList.add("dragging");return}}let n=!1;this.vanishingPoints.forEach((i,s)=>{Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2))<this.HANDLE_SIZE/this.scale&&(this.draggingPointIndex=s,this.selectPoint(i.id),this.canvasElement.nativeElement.classList.add("dragging"),n=!0)}),n||(this.isPanning=!0,this.lastPanPosition={x:e.clientX,y:e.clientY})}onMouseMove(e){if(this.mode==="Production"||!this.isInteractingWithCanvas)return;let t=this.screenToWorld(e.offsetX,e.offsetY);if(this.isPanning){let n=e.clientX-this.lastPanPosition.x,i=e.clientY-this.lastPanPosition.y;this.panX+=n,this.panY+=i,this.lastPanPosition={x:e.clientX,y:e.clientY};return}if(this.isDraggingFrame){let n=t.x-this.lastFrameDragPosition.x,i=t.y-this.lastFrameDragPosition.y;this.framePoints.forEach(s=>{s.x+=n,s.y+=i}),this.lastFrameDragPosition=t;return}this.resizeFrame(t)||this.dragVanishingPoint(t)}onMouseUp(e){this.isInteractingWithCanvas=!1,this.draggingPointIndex=-1,this.draggingFramePointIndex=-1,this.isDraggingFrame=!1,this.isPanning=!1,this.canvasElement.nativeElement.classList.remove("dragging","panning")}resizeFrame(e){if(this.draggingFramePointIndex>-1){if(this.framePoints.length===4){let t={x:(this.framePoints[0].x+this.framePoints[1].x+this.framePoints[2].x+this.framePoints[3].x)/4,y:(this.framePoints[0].y+this.framePoints[1].y+this.framePoints[2].y+this.framePoints[3].y)/4},n=this.framePoints[this.draggingFramePointIndex],i={x:n.x-t.x,y:n.y-t.y},s={x:e.x-t.x,y:e.y-t.y},o=Math.sqrt(i.x*i.x+i.y*i.y),m=Math.sqrt(s.x*s.x+s.y*s.y);if(o>0){let a=m/o,d=JSON.parse(JSON.stringify(this.framePoints));this.framePoints.forEach((P,y)=>{let _={x:d[y].x-t.x,y:d[y].y-t.y};this.framePoints[y]={x:t.x+_.x*a,y:t.y+_.y*a}})}}return!0}return!1}dragVanishingPoint(e){if(this.draggingPointIndex>-1){let t=this.vanishingPoints[this.draggingPointIndex];if(t.isAnchored&&t.initialXOffset!==null){let n=this.horizonRotation*Math.PI/180,i={x:0,y:0},s=e.x-i.x,o=e.y-i.y;t.initialXOffset=s*Math.cos(-n)-o*Math.sin(-n),this.updateConstrainedPointsPosition()}else if(t.isPerpendicular&&t.perpendicularOffset!=null){let n=this.horizonRotation*Math.PI/180,i={x:0,y:0},s=e.x-i.x,m=(e.y-i.y)*Math.cos(n)-s*Math.sin(n);t.perpendicularOffset=-m,this.vanishingPoints.filter(d=>d.pairId===t.pairId).forEach(d=>{d.id!==t.id&&(d.perpendicularOffset=-t.perpendicularOffset)}),this.updateConstrainedPointsPosition()}else t.x=e.x,t.y=e.y}}onWheel(e){e.preventDefault();let t=this.SCALE_AMOUNT,n={x:e.offsetX,y:e.offsetY},i=this.screenToWorld(n.x,n.y);e.deltaY<0?this.scale*=t:this.scale/=t,this.scale=Math.max(this.MIN_SCALE,Math.min(this.scale,this.MAX_SCALE));let s=this.screenToWorld(n.x,n.y);this.panX+=(s.x-i.x)*this.scale,this.panY+=(s.y-i.y)*this.scale}getDistance(e){let t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+n*n)}onTouchStart(e){if(this.mode==="Production"){if(e.touches.length===1){let t=e.touches[0],n=this.canvasElement.nativeElement.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top;this.productionPoint=this.screenToWorld(i,s)}e.preventDefault();return}if(e.touches.length===1){let t=e.touches[0],n=this.canvasElement.nativeElement.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top,o=this.screenToWorld(i,s);if(this.isInteractingWithCanvas=!0,this.selectedAspectRatio!=="none"){for(let a=0;a<this.framePoints.length;a++){let d=this.framePoints[a];if(Math.sqrt(Math.pow(d.x-o.x,2)+Math.pow(d.y-o.y,2))<this.TOUCH_HANDLE_SIZE/this.scale){this.draggingFramePointIndex=a,this.canvasElement.nativeElement.classList.add("dragging"),e.preventDefault();return}}if(this.isPointInFrame(o)){this.isDraggingFrame=!0,this.lastFrameDragPosition=o,this.canvasElement.nativeElement.classList.add("dragging"),e.preventDefault();return}}let m=!1;this.vanishingPoints.forEach((a,d)=>{Math.sqrt(Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2))<this.TOUCH_HANDLE_SIZE/this.scale&&(this.draggingPointIndex=d,this.selectPoint(a.id),this.canvasElement.nativeElement.classList.add("dragging"),m=!0)}),m||(this.isPanning=!0,this.lastPanPosition={x:t.clientX,y:t.clientY}),e.preventDefault()}else e.touches.length===2&&(this.isPanning=!1,this.initialPinchDistance=this.getDistance(e.touches))}onTouchMove(e){if(!(this.mode==="Production"||!this.isInteractingWithCanvas)){if(e.touches.length===1){let t=e.touches[0],n=this.canvasElement.nativeElement.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top,o=this.screenToWorld(i,s);if(this.isPanning){let m=t.clientX-this.lastPanPosition.x,a=t.clientY-this.lastPanPosition.y;this.panX+=m,this.panY+=a,this.lastPanPosition={x:t.clientX,y:t.clientY},e.preventDefault();return}if(this.isDraggingFrame){let m=o.x-this.lastFrameDragPosition.x,a=o.y-this.lastFrameDragPosition.y;this.framePoints.forEach(d=>{d.x+=m,d.y+=a}),this.lastFrameDragPosition=o,e.preventDefault();return}if(this.resizeFrame(o)){e.preventDefault();return}this.dragVanishingPoint(o),e.preventDefault()}else if(e.touches.length===2){let t=this.getDistance(e.touches),n=t/this.initialPinchDistance,i=this.canvasElement.nativeElement.getBoundingClientRect(),s={x:(e.touches[0].clientX+e.touches[1].clientX)/2-i.left,y:(e.touches[0].clientY+e.touches[1].clientY)/2-i.top},o=this.screenToWorld(s.x,s.y);this.scale*=n,this.scale=Math.max(this.MIN_SCALE,Math.min(this.scale,this.MAX_SCALE));let m=this.screenToWorld(s.x,s.y);this.panX+=(m.x-o.x)*this.scale,this.panY+=(m.y-o.y)*this.scale,this.initialPinchDistance=t}e.preventDefault()}}onTouchEnd(e){this.isInteractingWithCanvas=!1,this.draggingPointIndex=-1,this.draggingFramePointIndex=-1,this.isDraggingFrame=!1,this.isPanning=!1,this.canvasElement.nativeElement.classList.remove("dragging","panning"),e.touches.length<2&&(this.initialPinchDistance=0)}toggleCamera(){this.showCamera=!this.showCamera}toggleTheme(){this.theme=this.theme==="light"?"dark":"light"}toggleParallelLines(){this.drawParallel=!this.drawParallel}togglePerpendicularLines(){this.drawPerpendicular=!this.drawPerpendicular}drawParallelLines(e=null){let{width:t,height:n}=this.canvasElement.nativeElement,i=this.horizonRotation*Math.PI/180;this.ctx.save(),this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=1/this.scale,this.ctx.rotate(i);let s=t/this.scale;if(e){let o=-e.x*Math.sin(i)+e.y*Math.cos(i);this.ctx.beginPath(),this.ctx.moveTo(-s*4,o),this.ctx.lineTo(s*4,o),this.ctx.stroke()}else{let m=n/this.scale/this.lineCount;for(let a=-this.lineCount;a<=this.lineCount;a++){if(a===0)continue;let d=a*m;this.ctx.beginPath(),this.ctx.moveTo(-s*4,d),this.ctx.lineTo(s*4,d),this.ctx.stroke()}}this.ctx.restore()}drawPerpendicularLines(e=null){let{width:t,height:n}=this.canvasElement.nativeElement,i=this.horizonRotation*Math.PI/180;this.ctx.save(),this.ctx.strokeStyle="#FF00FF",this.ctx.lineWidth=1/this.scale,this.ctx.rotate(i);let s=n/this.scale;if(e){let o=e.x*Math.cos(i)+e.y*Math.sin(i);this.ctx.beginPath(),this.ctx.moveTo(o,-s*4),this.ctx.lineTo(o,s*4),this.ctx.stroke()}else{let m=t/this.scale/this.lineCount;for(let a=-this.lineCount;a<=this.lineCount;a++){let d=a*m;this.ctx.beginPath(),this.ctx.moveTo(d,-s*4),this.ctx.lineTo(d,s*4),this.ctx.stroke()}}this.ctx.restore()}static \u0275fac=function(t){return new(t||r)(z(j),z(tt))};static \u0275cmp=U({type:r,selectors:[["app-perspective-grid"]],viewQuery:function(t,n){if(t&1&&(A(_t,5),A(Pt,5),A(yt,5),A(Ct,5)),t&2){let i;R(i=L())&&(n.videoElement=i.first),R(i=L())&&(n.canvasElement=i.first),R(i=L())&&(n.toggleButton=i.first),R(i=L())&&(n.controlsPanel=i.first)}},hostBindings:function(t,n){t&1&&f("click",function(s){return n.onDocumentInteraction(s)},!1,H)("touchstart",function(s){return n.onDocumentInteraction(s)},!1,H)("resize",function(){return n.onResize()},!1,q)},decls:11,vars:13,consts:[["videoElement",""],["canvasElement",""],["toggleButton",""],["controlsPanel",""],[1,"relative","w-full","h-screen",3,"ngClass"],[1,"absolute","top-0","left-0","w-full","h-full","object-cover"],[1,"absolute","top-0","left-0","w-full","h-full",3,"click"],[1,"absolute","top-4","left-4","z-10"],[1,"bg-opacity-75","p-2","rounded-full","mb-2",3,"click","ngClass"],["xmlns","http://www.w3.org/2000/svg","class","h-6 w-6","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngIf"],["class","bg-opacity-75 p-4 rounded-lg w-72",3,"ngClass",4,"ngIf"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 6h16M4 12h16M4 18h16"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M6 18L18 6M6 6l12 12"],[1,"bg-opacity-75","p-4","rounded-lg","w-72",3,"ngClass"],["routerLink","/",1,"flex","items-center","text-lg","font-bold","mb-4","w-full","text-left","p-2","rounded-lg","shadow-md",3,"ngClass"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","mr-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 19l-7-7 7-7"],[1,"mb-4"],[1,"w-full","font-bold","py-2","px-4","rounded",3,"click","ngClass"],["class","mb-4",4,"ngIf"],[1,"w-full","bg-blue-500","hover:bg-blue-700","text-white","font-bold","py-2","px-4","rounded","mb-2",3,"click"],[1,"flex","items-center","justify-between","mb-2"],[1,"block"],["title","A\xF1adir Punto Libre",1,"bg-green-500","hover:bg-green-700","text-white","font-bold","py-1","px-2","rounded","mr-2",3,"click"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-4","w-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],["class","p-2 rounded mb-1 cursor-pointer",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"my-4","border-gray-600"],["title","A\xF1adir par de PV en horizonte",1,"bg-indigo-500","hover:bg-indigo-700","text-white","font-bold","py-1","px-2","rounded",3,"click"],["title","A\xF1adir par de PV perpendicular",1,"bg-purple-500","hover:bg-purple-700","text-white","font-bold","py-1","px-2","rounded","mt-2",3,"click"],[1,"p-2","rounded","mb-1","cursor-pointer",3,"click","ngClass"],[1,"flex","items-center","justify-between"],[1,"flex","items-center"],["type","color",1,"w-8","h-8","mr-2",3,"ngModelChange","click","ngModel"],[1,"text-red-500","hover:text-red-700",3,"click"],["class","mt-2",4,"ngIf"],[1,"mt-2"],[4,"ngIf"],["type","checkbox",1,"mr-2",3,"ngModelChange","ngModel"],[1,"block","mb-2",3,"for"],["type","range","min","0","max","2","step","0.01",1,"w-full",3,"ngModelChange","id","ngModel"],["for","horizonRotation",1,"block","mb-2"],["id","horizonRotation","type","range","min","-90","max","90",1,"w-full",3,"ngModelChange","ngModel"],["for","lines",1,"block","mb-2"],["id","lines","type","range","min","2","max","50",1,"w-full",3,"ngModelChange","ngModel"],[1,"mt-2","flex","justify-between"],[1,"w-1/2","bg-sky-500","hover:bg-sky-700","text-white","font-bold","py-2","px-4","rounded","mr-1",3,"click"],[1,"w-1/2","bg-teal-500","hover:bg-teal-700","text-white","font-bold","py-2","px-4","rounded","ml-1",3,"click"],[1,"text-md","font-bold","mb-2"],[1,"mb-2"],["for","aspectRatio",1,"block","mb-1"],["id","aspectRatio",1,"w-full","rounded","py-1","px-2",3,"ngModelChange","ngModel","ngClass"],[3,"value",4,"ngFor","ngForOf"],["class","flex items-center justify-between",4,"ngIf"],[1,"flex","mt-2","space-x-2"],[1,"w-full","bg-green-500","hover:bg-green-700","text-white","font-bold","py-2","px-4","rounded",3,"click"],[3,"value"],["type","number",1,"w-1/2","rounded","py-1","px-2","mr-1",3,"ngModelChange","ngModel","ngClass"],["type","number",1,"w-1/2","rounded","py-1","px-2","ml-1",3,"ngModelChange","ngModel","ngClass"],["for","cameraSelect",1,"block","mb-1"],["id","cameraSelect",1,"w-full","rounded","py-1","px-2",3,"change","value","ngClass"]],template:function(t,n){if(t&1){let i=C();c(0,"div",4),k(1,"video",5,0),c(3,"canvas",6,1),f("click",function(o){return p(i),v(n.onCanvasClick(o))}),h(),c(5,"div",7)(6,"button",8,2),f("click",function(){return p(i),v(n.gridControlsCollapsed=!n.gridControlsCollapsed)}),b(8,Tt,2,0,"svg",9)(9,kt,2,0,"svg",9),h(),b(10,zt,19,24,"div",10),h()()}t&2&&(g("ngClass",w(7,wt,n.theme==="dark",n.theme==="light")),l(),W("hidden",!n.showCamera),l(5),g("ngClass",w(10,ut,n.theme==="dark",n.theme==="light")),l(2),g("ngIf",n.gridControlsCollapsed),l(),g("ngIf",!n.gridControlsCollapsed),l(),g("ngIf",!n.gridControlsCollapsed))},dependencies:[$,Q,J,K,ht,lt,dt,nt,rt,at,it,ct,st,ot,et],styles:[".panning[_ngcontent-%COMP%]{cursor:grabbing}.dragging[_ngcontent-%COMP%]{cursor:move}"]})};export{mt as PerspectiveGridComponent};
