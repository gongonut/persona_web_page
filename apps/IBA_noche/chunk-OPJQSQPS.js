import{a as it,b as nt,c as st,d as ot,e as rt,f as at,g as lt,h as ct,i as ht,j as dt}from"./chunk-P34YCOLR.js";import{$ as k,D as C,G as f,I as W,J as d,K as m,L as V,M as b,N as y,O as p,P as z,Q as S,R as A,S as L,T as P,U as Q,V as F,W as E,X as M,Y as I,aa as U,c as H,ja as J,ka as Z,l as u,la as K,m as x,n as R,o as G,pa as $,r as B,sa as tt,ta as et,u as N,v as q,w as g,y as O,z as j}from"./chunk-DS4NGIYP.js";var pt=["videoElement"],ut=["canvasElement"],xt=["toggleButton"],ft=["controlsPanel"],vt=(h,e)=>({"bg-gray-900":h,"bg-gray-100":e}),gt=(h,e)=>({"bg-gray-800 text-white":h,"bg-white text-black shadow-lg":e}),Pt=(h,e)=>({"bg-gray-700 hover:bg-gray-600 text-white":h,"bg-gray-200 hover:bg-gray-300 text-black":e}),X=(h,e)=>({"bg-gray-700 border border-gray-600":h,"bg-gray-200 border border-gray-300":e}),yt=(h,e)=>({"bg-gray-600 hover:bg-gray-500":h,"bg-gray-300 hover:bg-gray-400":e}),_t=(h,e,t,n,i,s)=>({"bg-gray-600":h,"bg-gray-700":e,"bg-gray-800":t,"bg-blue-200":n,"bg-gray-200":i,"bg-white":s});function wt(h,e){h&1&&(R(),d(0,"svg",11),V(1,"path",12),m())}function Ct(h,e){h&1&&(R(),d(0,"svg",11),V(1,"path",13),m())}function bt(h,e){if(h&1){let t=b();d(0,"div")(1,"label",48)(2,"input",54),I("ngModelChange",function(i){u(t);let s=p(2).$implicit;return M(s.isAnchored,i)||(s.isAnchored=i),x(i)}),y("ngModelChange",function(){u(t);let i=p(2).$implicit,s=p(2);return x(s.toggleAnchor(i))}),m(),d(3,"span"),P(4,"Anclar al Horizonte"),m()()()}if(h&2){let t=p(2).$implicit;g(2),E("ngModel",t.isAnchored)}}function Et(h,e){if(h&1){let t=b();d(0,"div")(1,"div",18)(2,"label",55),P(3),m(),d(4,"input",56),I("ngModelChange",function(i){u(t);let s=p(2).$implicit;return M(s.curvature,i)||(s.curvature=i),x(i)}),m()()()}if(h&2){let t=p(2).$implicit;g(2),z("for","curvature-",t.id,""),g(),F("Curvatura: ",t.curvature,""),g(),z("id","curvature-",t.id,""),E("ngModel",t.curvature)}}function Mt(h,e){if(h&1&&(d(0,"div",52),C(1,bt,5,1,"div",53)(2,Et,5,6,"div",53),m()),h&2){let t=p().$implicit;g(),f("ngIf",t.pairId===null),g(),f("ngIf",t.pairId!==null)}}function It(h,e){if(h&1){let t=b();d(0,"div",46),y("click",function(){let i=u(t).$implicit,s=p(2);return x(s.selectPoint(i.id))}),d(1,"div",47)(2,"div",48)(3,"input",49),I("ngModelChange",function(i){let s=u(t).$implicit;return M(s.color,i)||(s.color=i),x(i)}),y("click",function(i){return u(t),x(i.stopPropagation())}),m(),d(4,"span"),P(5),m()(),d(6,"button",50),y("click",function(i){let s=u(t).$implicit;return p(2).removePerspectivePoint(s.id),x(i.stopPropagation())}),R(),d(7,"svg",22),V(8,"path",13),m()()(),C(9,Mt,3,2,"div",51),m()}if(h&2){let t=e.$implicit,n=e.index,i=p(2);f("ngClass",U(4,_t,i.selectedPointId===t.id&&i.theme==="dark",i.selectedPointId!==t.id&&i.selectedPointId!==null&&i.theme==="dark",i.selectedPointId===null&&i.theme==="dark",i.selectedPointId===t.id&&i.theme==="light",i.selectedPointId!==t.id&&i.selectedPointId!==null&&i.theme==="light",i.selectedPointId===null&&i.theme==="light")),g(3),E("ngModel",t.color),g(2),F("Punto ",n+1,""),g(4),f("ngIf",i.selectedPointId===t.id)}}function kt(h,e){if(h&1&&(d(0,"option",57),P(1),m()),h&2){let t=e.$implicit;f("value",t.value),g(),Q(t.name)}}function Tt(h,e){if(h&1){let t=b();d(0,"div",47)(1,"input",58),I("ngModelChange",function(i){u(t);let s=p(2);return M(s.customAspectRatioWidth,i)||(s.customAspectRatioWidth=i),x(i)}),m(),d(2,"span"),P(3,":"),m(),d(4,"input",59),I("ngModelChange",function(i){u(t);let s=p(2);return M(s.customAspectRatioHeight,i)||(s.customAspectRatioHeight=i),x(i)}),m()()}if(h&2){let t=p(2);g(),E("ngModel",t.customAspectRatioWidth),f("ngClass",k(4,X,t.theme==="dark",t.theme==="light")),g(3),E("ngModel",t.customAspectRatioHeight),f("ngClass",k(7,X,t.theme==="dark",t.theme==="light"))}}function Vt(h,e){if(h&1){let t=b();d(0,"button",60),y("click",function(){u(t);let i=p(2);return x(i.recordFrame())}),P(1," Grabar "),m()}}function Ft(h,e){if(h&1){let t=b();d(0,"button",61),y("click",function(){u(t);let i=p(2);return x(i.shareFrame())}),P(1," Compartir "),m()}}function Rt(h,e){if(h&1){let t=b();d(0,"div",14,3)(2,"button",15),R(),d(3,"svg",16),V(4,"path",17),m(),G(),d(5,"span"),P(6,"Men\xFA/Asistente de Perspectiva"),m()(),d(7,"div",18)(8,"div",19)(9,"label",20),P(10,"Puntos de Perspectiva"),m(),d(11,"div")(12,"button",21),y("click",function(){u(t);let i=p();return x(i.addPerspectivePoint())}),R(),d(13,"svg",22),V(14,"path",23),m()()()(),C(15,It,10,11,"div",24),G(),V(16,"hr",25),d(17,"button",26),y("click",function(){u(t);let i=p();return x(i.addHorizonVPPair())}),P(18," A\xF1adir par de PV en horizonte "),m(),d(19,"button",27),y("click",function(){u(t);let i=p();return x(i.addPerpendicularVPPair())}),P(20," A\xF1adir par de PV perpendicular "),m()(),d(21,"div",18)(22,"label",28),P(23),m(),d(24,"input",29),I("ngModelChange",function(i){u(t);let s=p();return M(s.horizonRotation,i)||(s.horizonRotation=i),x(i)}),m()(),d(25,"div",18)(26,"label",30),P(27),m(),d(28,"input",31),I("ngModelChange",function(i){u(t);let s=p();return M(s.lineCount,i)||(s.lineCount=i),x(i)}),m(),d(29,"div",32)(30,"button",33),y("click",function(){u(t);let i=p();return x(i.toggleParallelLines())}),P(31," Paralelas "),m(),d(32,"button",34),y("click",function(){u(t);let i=p();return x(i.togglePerpendicularLines())}),P(33," Perpendiculares "),m()()(),d(34,"div",18)(35,"h4",35),P(36,"Superposici\xF3n de Marco"),m(),d(37,"div",36)(38,"label",37),P(39,"Relaci\xF3n de Aspecto"),m(),d(40,"select",38),I("ngModelChange",function(i){u(t);let s=p();return M(s.selectedAspectRatio,i)||(s.selectedAspectRatio=i),x(i)}),y("ngModelChange",function(){u(t);let i=p();return x(i.onAspectRatioChange())}),C(41,kt,2,2,"option",39),m()(),C(42,Tt,5,10,"div",40),d(43,"div",41),C(44,Vt,2,0,"button",42)(45,Ft,2,0,"button",43),m()(),d(46,"button",44),y("click",function(){u(t);let i=p();return x(i.toggleCamera())}),P(47),m(),d(48,"button",45),y("click",function(){u(t);let i=p();return x(i.toggleTheme())}),P(49),m()()}if(h&2){let t=p();f("ngClass",k(20,gt,t.theme==="dark",t.theme==="light")),g(2),f("ngClass",k(23,Pt,t.theme==="dark",t.theme==="light")),g(13),f("ngForOf",t.vanishingPoints),g(8),F("Rotaci\xF3n del Horizonte: ",t.horizonRotation,"\xB0"),g(),E("ngModel",t.horizonRotation),g(3),F("Cantidad de L\xEDneas: ",t.lineCount,""),g(),E("ngModel",t.lineCount),g(2),W("bg-sky-700",t.drawParallel),g(2),W("bg-teal-700",t.drawPerpendicular),g(8),E("ngModel",t.selectedAspectRatio),f("ngClass",k(26,X,t.theme==="dark",t.theme==="light")),g(),f("ngForOf",t.aspectRatios),g(),f("ngIf",t.selectedAspectRatio==="custom"),g(2),f("ngIf",t.selectedAspectRatio!=="none"),g(),f("ngIf",t.selectedAspectRatio!=="none"),g(2),F(" ",t.showCamera?"Ocultar":"Mostrar"," C\xE1mara "),g(),f("ngClass",k(29,yt,t.theme==="dark",t.theme==="light")),g(),F(" Cambiar a Tema ",t.theme==="dark"?"Claro":"Oscuro"," ")}}var mt=class h{constructor(e,t){this.elementRef=e;this.router=t}gridControlsCollapsed=!1;theme="dark";videoElement;canvasElement;toggleButton;controlsPanel;_horizonLevel=0;_horizonRotation=0;lineCount=10;showCamera=!0;drawParallel=!1;drawPerpendicular=!1;aspectRatios=[{name:"None",value:"none"},{name:"1:1",value:"1/1"},{name:"16:9",value:"16/9"},{name:"9:16",value:"9/16"},{name:"4:3",value:"4/3"},{name:"3:2",value:"3/2"},{name:"Custom",value:"custom"}];selectedAspectRatio="none";customAspectRatioWidth=16;customAspectRatioHeight=9;scale=1;panX=0;panY=0;isPanning=!1;lastPanPosition={x:0,y:0};initialPinchDistance=0;isDraggingFrame=!1;lastFrameDragPosition={x:0,y:0};get horizonRotation(){return this._horizonRotation}set horizonRotation(e){this._horizonRotation!==e&&(this._horizonRotation=e,this.updateConstrainedPointsPosition())}ctx;videoStream;vanishingPoints=[];framePoints=[];draggingPointIndex=-1;draggingFramePointIndex=-1;nextPointId=0;nextPairId=0;selectedPointId=null;ngAfterViewInit(){let e=this.canvasElement.nativeElement;this.ctx=e.getContext("2d"),this.setupCanvas(),this.startCamera(),this.initVanishingPoints(),this.initFramePoints(),this.draw(),e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("mouseup",this.onMouseUp.bind(this)),e.addEventListener("wheel",this.onWheel.bind(this)),e.addEventListener("touchstart",this.onTouchStart.bind(this)),e.addEventListener("touchmove",this.onTouchMove.bind(this)),e.addEventListener("touchend",this.onTouchEnd.bind(this))}onDocumentClick(e){if(this.gridControlsCollapsed)return;let t=e.target;this.toggleButton?.nativeElement.contains(t)||this.controlsPanel&&!this.controlsPanel.nativeElement.contains(t)&&(this.gridControlsCollapsed=!0)}onResize(){this.setupCanvas()}screenToWorld(e,t){return{x:(e-this.panX)/this.scale,y:(t-this.panY)/this.scale}}setupCanvas(){let e=this.canvasElement.nativeElement;e.width=e.offsetWidth,e.height=e.offsetHeight,this._horizonLevel=e.height/2,this.panY=this._horizonLevel}startCamera(){return H(this,null,function*(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{this.videoStream=yield navigator.mediaDevices.getUserMedia({video:!0}),this.videoElement.nativeElement.srcObject=this.videoStream,this.videoElement.nativeElement.play()}catch(e){console.error("Error accessing camera: ",e),this.showCamera=!1}})}toggleCamera(){this.showCamera=!this.showCamera,this.showCamera?this.startCamera():this.videoStream&&this.videoStream.getTracks().forEach(e=>e.stop())}initVanishingPoints(){this.vanishingPoints.length===0&&this.addPerspectivePoint()}initFramePoints(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.screenToWorld(e/2,t/2),i=e/2/this.scale,s=t/2/this.scale;this.framePoints=[{x:n.x-i/2,y:n.y-s/2},{x:n.x+i/2,y:n.y-s/2},{x:n.x+i/2,y:n.y+s/2},{x:n.x-i/2,y:n.y+s/2}]}getRandomColor(){let e="0123456789ABCDEF",t="#";for(let n=0;n<6;n++)t+=e[Math.floor(Math.random()*16)];return t}addPerspectivePoint(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.screenToWorld(e/2,t/2),i={id:this.nextPointId++,x:n.x,y:n.y,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:null,curvature:.5};this.vanishingPoints.push(i),this.selectPoint(i.id)}addHorizonVPPair(){let{width:e}=this.canvasElement.nativeElement,t=this.nextPairId++,n={x:0,y:this._horizonLevel},i=-e*.25,s=e*.25,r={id:this.nextPointId++,x:n.x+i,y:n.y,color:this.getRandomColor(),isAnchored:!0,initialXOffset:i,pairId:t,curvature:.5},o={id:this.nextPointId++,x:n.x+s,y:n.y,color:this.getRandomColor(),isAnchored:!0,initialXOffset:s,pairId:t,curvature:.5};this.vanishingPoints.push(r,o),this.updateConstrainedPointsPosition(),this.selectPoint(r.id)}addPerpendicularVPPair(){let e=this.nextPairId++,t={x:0,y:this._horizonLevel},n=-200,i=200,s={id:this.nextPointId++,x:t.x,y:t.y+n,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:e,curvature:.5,isPerpendicular:!0,perpendicularOffset:n},r={id:this.nextPointId++,x:t.x,y:t.y+i,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:e,curvature:.5,isPerpendicular:!0,perpendicularOffset:i};this.vanishingPoints.push(s,r),this.updateConstrainedPointsPosition(),this.selectPoint(s.id)}removePerspectivePoint(e){let t=this.vanishingPoints.find(n=>n.id===e);t&&(t.pairId!==null?this.vanishingPoints=this.vanishingPoints.filter(n=>n.pairId!==t.pairId):this.vanishingPoints=this.vanishingPoints.filter(n=>n.id!==e),(this.selectedPointId===e||t.pairId!==null&&this.vanishingPoints.every(n=>n.pairId!==t.pairId))&&(this.selectedPointId=null))}onAspectRatioChange(){if(this.selectedAspectRatio==="none"){this.framePoints=[];return}let e;if(this.selectedAspectRatio==="custom")if(this.customAspectRatioWidth>0&&this.customAspectRatioHeight>0)e=this.customAspectRatioWidth/this.customAspectRatioHeight;else return;else{let o=this.selectedAspectRatio.split("/").map(Number);e=o[0]/o[1]}let{width:t,height:n}=this.canvasElement.nativeElement,i=this.screenToWorld(t/2,n/2),s=300/this.scale,r=s/e;this.framePoints=[{x:i.x-s/2,y:i.y-r/2},{x:i.x+s/2,y:i.y-r/2},{x:i.x+s/2,y:i.y+r/2},{x:i.x-s/2,y:i.y+r/2}]}selectPoint(e){this.selectedPointId===e?this.selectedPointId=null:this.selectedPointId=e}toggleAnchor(e){let t={x:0,y:this._horizonLevel};e.isAnchored?(e.initialXOffset=e.x-t.x,this.updateConstrainedPointsPosition()):e.initialXOffset=null}updateConstrainedPointsPosition(){let e={x:0,y:this._horizonLevel},t=this.horizonRotation*Math.PI/180;this.vanishingPoints.forEach(n=>{n.isAnchored&&n.initialXOffset!==null?(n.x=e.x+n.initialXOffset*Math.cos(t),n.y=e.y+n.initialXOffset*Math.sin(t)):n.isPerpendicular&&n.perpendicularOffset!=null&&(n.x=e.x+n.perpendicularOffset*Math.sin(t),n.y=e.y-n.perpendicularOffset*Math.cos(t))})}draw(){requestAnimationFrame(()=>this.draw());let e=this.canvasElement.nativeElement,{width:t,height:n}=e;this.ctx.clearRect(0,0,t,n),this.showCamera&&this.videoElement.nativeElement.readyState===4&&this.ctx.drawImage(this.videoElement.nativeElement,0,0,t,n),this.ctx.save(),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.scale,this.scale),this.drawGrid(),this.drawVanishingPoints(),this.drawPerspectiveFrame(),this.ctx.restore(),this.drawFrameOverlay()}drawPerspectiveFrame(){if(!(this.selectedAspectRatio==="none"||this.framePoints.length!==4)){this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=2/this.scale,this.ctx.beginPath(),this.ctx.moveTo(this.framePoints[0].x,this.framePoints[0].y);for(let e=1;e<=this.framePoints.length;e++)this.ctx.lineTo(this.framePoints[e%this.framePoints.length].x,this.framePoints[e%this.framePoints.length].y);this.ctx.stroke(),this.framePoints.forEach(e=>{this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,8/this.scale,0,Math.PI*2),this.ctx.fill()})}}drawFrameOverlay(){if(this.selectedAspectRatio==="none"||this.framePoints.length!==4)return;let e=this.canvasElement.nativeElement,{width:t,height:n}=e,i=this.framePoints.map(s=>({x:s.x*this.scale+this.panX,y:s.y*this.scale+this.panY}));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(t,0),this.ctx.lineTo(t,n),this.ctx.lineTo(0,n),this.ctx.closePath(),this.ctx.moveTo(i[0].x,i[0].y);for(let s=1;s<i.length;s++)this.ctx.lineTo(i[s].x,i[s].y);this.ctx.closePath(),this.ctx.fill("evenodd"),this.ctx.restore()}isPointInFrame(e){if(this.framePoints.length!==4)return!1;let t=this.framePoints[0],n=this.framePoints[1],i=this.framePoints[2],s=this.framePoints[3],r=(n.x-t.x)*(e.y-t.y)-(n.y-t.y)*(e.x-t.x),o=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),c=(s.x-i.x)*(e.y-i.y)-(s.y-i.y)*(e.x-i.x),a=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x),l=r<0||o<0||c<0||a<0,_=r>0||o>0||c>0||a>0;return!(l&&_)}getFrameImageDataUrl(){if(this.framePoints.length!==4)return null;let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return console.error("Could not create output canvas context"),null;let n=this.framePoints.map(v=>({x:v.x*this.scale+this.panX,y:v.y*this.scale+this.panY})),i=n.map(v=>v.x),s=n.map(v=>v.y),r=Math.min(...i),o=Math.min(...s),c=Math.max(...i),a=Math.max(...s),l=c-r,_=a-o;e.width=l,e.height=_,t.beginPath(),t.moveTo(n[0].x-r,n[0].y-o);for(let v=1;v<n.length;v++)t.lineTo(n[v].x-r,n[v].y-o);return t.closePath(),t.clip(),t.drawImage(this.canvasElement.nativeElement,-r,-o),e.toDataURL("image/png")}recordFrame(){let e=this.getFrameImageDataUrl();if(e){let t=document.createElement("a");t.href=e,t.download="perspective-frame.png",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}shareFrame(){let e=this.getFrameImageDataUrl();e&&this.router.navigate(["/camara-lucida-digital"],{state:{image:e}})}drawGrid(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.horizonRotation*Math.PI/180,i={x:0,y:this._horizonLevel};this.ctx.save(),this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2/this.scale,this.ctx.translate(i.x,i.y),this.ctx.rotate(n),this.ctx.beginPath();let s=e/this.scale;this.ctx.moveTo(-s*4,0),this.ctx.lineTo(s*4,0),this.ctx.stroke(),this.ctx.restore(),this.drawParallel&&this.drawParallelLines(),this.drawPerpendicular&&this.drawPerpendicularLines();let r=this.vanishingPoints.filter(l=>l.pairId===null),o=this.vanishingPoints.filter(l=>l.pairId!==null),c=new Map;o.forEach(l=>{l.isPerpendicular&&(c.has(l.pairId)||c.set(l.pairId,[]),c.get(l.pairId).push(l))}),c.forEach(l=>{if(l.length===2){this.ctx.save(),this.ctx.strokeStyle="#FF00FF",this.ctx.lineWidth=1/this.scale,this.ctx.globalAlpha=.5,this.ctx.translate(i.x,i.y),this.ctx.rotate(n),this.ctx.beginPath();let _=t/this.scale;this.ctx.moveTo(0,-_*4),this.ctx.lineTo(0,_*4),this.ctx.stroke(),this.ctx.restore()}}),r.forEach(l=>{this.drawLinesToPoint(l)});let a=new Map;o.forEach(l=>{a.has(l.pairId)||a.set(l.pairId,[]),a.get(l.pairId).push(l)}),a.forEach(l=>{l.length===2&&this.drawGeodesicGrid(l[0],l[1])})}drawLinesToPoint(e){let{width:t,height:n}=this.canvasElement.nativeElement;this.ctx.strokeStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id?"gray":e.color,this.ctx.lineWidth=1/this.scale;let i=this.screenToWorld(0,0),s=this.screenToWorld(t,0),r=this.screenToWorld(0,n),o=this.screenToWorld(t,n),c=this.lineCount;for(let a=0;a<=c;a++){let l=i.x+(s.x-i.x)*(a/c);this.ctx.beginPath(),this.ctx.moveTo(l,i.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}for(let a=0;a<=c;a++){let l=r.x+(o.x-r.x)*(a/c);this.ctx.beginPath(),this.ctx.moveTo(l,r.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}for(let a=0;a<=c;a++){let l=i.y+(r.y-i.y)*(a/c);this.ctx.beginPath(),this.ctx.moveTo(i.x,l),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}for(let a=0;a<=c;a++){let l=s.y+(o.y-s.y)*(a/c);this.ctx.beginPath(),this.ctx.moveTo(s.x,l),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}}drawGeodesicGrid(e,t){this.ctx.strokeStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id&&this.selectedPointId!==t.id?"gray":e.color,this.ctx.lineWidth=1/this.scale;let n=t.x-e.x,i=t.y-e.y,s=Math.sqrt(n*n+i*i),r=-i/s,o=n/s;for(let c=0;c<=this.lineCount;c++){let a=(c-this.lineCount/2)/(this.lineCount/2),l=e.curvature*s*.5,_=e.x+n*.25+r*l*a,v=e.y+i*.25+o*l*a,T=e.x+n*.75+r*l*a,w=e.y+i*.75+o*l*a;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.bezierCurveTo(_,v,T,w,t.x,t.y),this.ctx.stroke()}}drawVanishingPoints(){this.vanishingPoints.forEach(e=>{this.ctx.fillStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id?"gray":e.color,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,10/this.scale,0,Math.PI*2),this.ctx.fill(),this.selectedPointId===e.id&&(this.ctx.strokeStyle="white",this.ctx.lineWidth=2/this.scale,this.ctx.stroke())})}onMouseDown(e){if(e.button===1){this.isPanning=!0,this.lastPanPosition={x:e.clientX,y:e.clientY},this.canvasElement.nativeElement.classList.add("panning"),e.preventDefault();return}let t=this.screenToWorld(e.offsetX,e.offsetY);if(this.selectedAspectRatio!=="none"){for(let n=0;n<this.framePoints.length;n++){let i=this.framePoints[n];if(Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2))<10/this.scale){this.draggingFramePointIndex=n,this.canvasElement.nativeElement.classList.add("dragging");return}}if(this.isPointInFrame(t)){this.isDraggingFrame=!0,this.lastFrameDragPosition=t,this.canvasElement.nativeElement.classList.add("dragging");return}}this.vanishingPoints.forEach((n,i)=>{Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))<10/this.scale&&(this.draggingPointIndex=i,this.selectPoint(n.id),this.canvasElement.nativeElement.classList.add("dragging"))})}onMouseMove(e){if(this.isPanning){let t=e.clientX-this.lastPanPosition.x,n=e.clientY-this.lastPanPosition.y;this.panX+=t,this.panY+=n,this.lastPanPosition={x:e.clientX,y:e.clientY};return}if(this.isDraggingFrame){let t=this.screenToWorld(e.offsetX,e.offsetY),n=t.x-this.lastFrameDragPosition.x,i=t.y-this.lastFrameDragPosition.y;this.framePoints.forEach(s=>{s.x+=n,s.y+=i}),this.lastFrameDragPosition=t;return}if(this.draggingFramePointIndex>-1){let t=this.screenToWorld(e.offsetX,e.offsetY);if(this.framePoints.length===4){let n={x:(this.framePoints[0].x+this.framePoints[1].x+this.framePoints[2].x+this.framePoints[3].x)/4,y:(this.framePoints[0].y+this.framePoints[1].y+this.framePoints[2].y+this.framePoints[3].y)/4},i=this.framePoints[this.draggingFramePointIndex],s={x:i.x-n.x,y:i.y-n.y},r={x:t.x-n.x,y:t.y-n.y},o=Math.sqrt(s.x*s.x+s.y*s.y),c=Math.sqrt(r.x*r.x+r.y*r.y);if(o>0){let a=c/o,l=JSON.parse(JSON.stringify(this.framePoints));this.framePoints.forEach((_,v)=>{let T={x:l[v].x-n.x,y:l[v].y-n.y};this.framePoints[v]={x:n.x+T.x*a,y:n.y+T.y*a}})}}return}if(this.draggingPointIndex>-1){let t=this.screenToWorld(e.offsetX,e.offsetY),n=this.vanishingPoints[this.draggingPointIndex];if(n.isAnchored&&n.initialXOffset!==null){let i=this.horizonRotation*Math.PI/180,s={x:0,y:this._horizonLevel},r=t.x-s.x,o=t.y-s.y;n.initialXOffset=r*Math.cos(-i)-o*Math.sin(-i),this.updateConstrainedPointsPosition()}else if(n.isPerpendicular&&n.perpendicularOffset!=null){let i=this.horizonRotation*Math.PI/180,s={x:0,y:this._horizonLevel},r=t.x-s.x,c=(t.y-s.y)*Math.cos(i)-r*Math.sin(i);n.perpendicularOffset=-c,this.vanishingPoints.filter(l=>l.pairId===n.pairId).forEach(l=>{l.id!==n.id&&(l.perpendicularOffset=-n.perpendicularOffset)}),this.updateConstrainedPointsPosition()}else n.x=t.x,n.y=t.y}}onMouseUp(e){this.draggingPointIndex=-1,this.draggingFramePointIndex=-1,this.isDraggingFrame=!1,this.isPanning=!1,this.canvasElement.nativeElement.classList.remove("dragging","panning")}onWheel(e){e.preventDefault();let t=1.1,n={x:e.offsetX,y:e.offsetY},i=this.screenToWorld(n.x,n.y);e.deltaY<0?this.scale*=t:this.scale/=t,this.scale=Math.max(.1,Math.min(this.scale,20));let s=this.screenToWorld(n.x,n.y);this.panX+=(s.x-i.x)*this.scale,this.panY+=(s.y-i.y)*this.scale}getDistance(e){let t=e[0].clientX-e[1].clientX,n=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+n*n)}onTouchStart(e){if(e.touches.length===1){let t=e.touches[0],n=this.canvasElement.nativeElement.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top,r=this.screenToWorld(i,s);if(this.selectedAspectRatio!=="none"){for(let c=0;c<this.framePoints.length;c++){let a=this.framePoints[c];if(Math.sqrt(Math.pow(a.x-r.x,2)+Math.pow(a.y-r.y,2))<20/this.scale){this.draggingFramePointIndex=c,this.canvasElement.nativeElement.classList.add("dragging"),e.preventDefault();return}}if(this.isPointInFrame(r)){this.isDraggingFrame=!0,this.lastFrameDragPosition=r,this.canvasElement.nativeElement.classList.add("dragging"),e.preventDefault();return}}let o=!1;this.vanishingPoints.forEach((c,a)=>{Math.sqrt(Math.pow(c.x-r.x,2)+Math.pow(c.y-r.y,2))<20/this.scale&&(this.draggingPointIndex=a,this.selectPoint(c.id),this.canvasElement.nativeElement.classList.add("dragging"),o=!0)}),o||(this.isPanning=!0,this.lastPanPosition={x:t.clientX,y:t.clientY},this.canvasElement.nativeElement.classList.add("panning")),e.preventDefault()}else e.touches.length===2&&(this.isPanning=!1,this.initialPinchDistance=this.getDistance(e.touches))}onTouchMove(e){if(e.touches.length===1){let t=e.touches[0],n=this.canvasElement.nativeElement.getBoundingClientRect(),i=t.clientX-n.left,s=t.clientY-n.top,r=this.screenToWorld(i,s);if(this.isPanning){let o=t.clientX-this.lastPanPosition.x,c=t.clientY-this.lastPanPosition.y;this.panX+=o,this.panY+=c,this.lastPanPosition={x:t.clientX,y:t.clientY};return}if(this.isDraggingFrame){let o=r.x-this.lastFrameDragPosition.x,c=r.y-this.lastFrameDragPosition.y;this.framePoints.forEach(a=>{a.x+=o,a.y+=c}),this.lastFrameDragPosition=r;return}if(this.draggingFramePointIndex>-1){if(this.framePoints.length===4){let o={x:(this.framePoints[0].x+this.framePoints[1].x+this.framePoints[2].x+this.framePoints[3].x)/4,y:(this.framePoints[0].y+this.framePoints[1].y+this.framePoints[2].y+this.framePoints[3].y)/4},c=this.framePoints[this.draggingFramePointIndex],a={x:c.x-o.x,y:c.y-o.y},l={x:r.x-o.x,y:r.y-o.y},_=Math.sqrt(a.x*a.x+a.y*a.y),v=Math.sqrt(l.x*l.x+l.y*l.y);if(_>0){let T=v/_,w=JSON.parse(JSON.stringify(this.framePoints));this.framePoints.forEach((St,D)=>{let Y={x:w[D].x-o.x,y:w[D].y-o.y};this.framePoints[D]={x:o.x+Y.x*T,y:o.y+Y.y*T}})}}return}if(this.draggingPointIndex>-1){let o=this.vanishingPoints[this.draggingPointIndex];if(o.isAnchored&&o.initialXOffset!==null){let c=this.horizonRotation*Math.PI/180,a={x:0,y:this._horizonLevel},l=r.x-a.x,_=r.y-a.y;o.initialXOffset=l*Math.cos(-c)-_*Math.sin(-c),this.updateConstrainedPointsPosition()}else if(o.isPerpendicular&&o.perpendicularOffset!=null){let c=this.horizonRotation*Math.PI/180,a={x:0,y:this._horizonLevel},l=r.x-a.x,v=(r.y-a.y)*Math.cos(c)-l*Math.sin(c);o.perpendicularOffset=-v,this.vanishingPoints.filter(w=>w.pairId===o.pairId).forEach(w=>{w.id!==o.id&&(w.perpendicularOffset=-o.perpendicularOffset)}),this.updateConstrainedPointsPosition()}else o.x=r.x,o.y=r.y}}else if(e.touches.length===2){let t=this.getDistance(e.touches),n=t/this.initialPinchDistance,i=this.canvasElement.nativeElement.getBoundingClientRect(),s={x:(e.touches[0].clientX+e.touches[1].clientX)/2-i.left,y:(e.touches[0].clientY+e.touches[1].clientY)/2-i.top},r=this.screenToWorld(s.x,s.y);this.scale*=n,this.scale=Math.max(.1,Math.min(this.scale,20));let o=this.screenToWorld(s.x,s.y);this.panX+=(o.x-r.x)*this.scale,this.panY+=(o.y-r.y)*this.scale,this.initialPinchDistance=t}e.preventDefault()}onTouchEnd(e){this.draggingPointIndex=-1,this.draggingFramePointIndex=-1,this.isDraggingFrame=!1,this.isPanning=!1,this.canvasElement.nativeElement.classList.remove("dragging","panning"),e.touches.length<2&&(this.initialPinchDistance=0)}toggleTheme(){this.theme=this.theme==="light"?"dark":"light"}toggleParallelLines(){this.drawParallel=!this.drawParallel}togglePerpendicularLines(){this.drawPerpendicular=!this.drawPerpendicular}drawParallelLines(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.horizonRotation*Math.PI/180,i={x:0,y:this._horizonLevel};this.ctx.save(),this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=1/this.scale,this.ctx.translate(i.x,i.y),this.ctx.rotate(n);let r=t/this.scale/this.lineCount,o=e/this.scale;for(let c=-this.lineCount;c<=this.lineCount;c++){if(c===0)continue;let a=c*r;this.ctx.beginPath(),this.ctx.moveTo(-o*4,a),this.ctx.lineTo(o*4,a),this.ctx.stroke()}this.ctx.restore()}drawPerpendicularLines(){let{width:e,height:t}=this.canvasElement.nativeElement,n=this.horizonRotation*Math.PI/180,i={x:0,y:this._horizonLevel};this.ctx.save(),this.ctx.strokeStyle="#FF00FF",this.ctx.lineWidth=1/this.scale,this.ctx.translate(i.x,i.y),this.ctx.rotate(n);let r=e/this.scale/this.lineCount,o=t/this.scale;for(let c=-this.lineCount;c<=this.lineCount;c++){let a=c*r;this.ctx.beginPath(),this.ctx.moveTo(a,-o*4),this.ctx.lineTo(a,o*4),this.ctx.stroke()}this.ctx.restore()}static \u0275fac=function(t){return new(t||h)(O(B),O(tt))};static \u0275cmp=j({type:h,selectors:[["app-perspective-grid"]],viewQuery:function(t,n){if(t&1&&(S(pt,5),S(ut,5),S(xt,5),S(ft,5)),t&2){let i;A(i=L())&&(n.videoElement=i.first),A(i=L())&&(n.canvasElement=i.first),A(i=L())&&(n.toggleButton=i.first),A(i=L())&&(n.controlsPanel=i.first)}},hostBindings:function(t,n){t&1&&y("click",function(s){return n.onDocumentClick(s)},!1,q)("resize",function(){return n.onResize()},!1,N)},decls:11,vars:13,consts:[["videoElement",""],["canvasElement",""],["toggleButton",""],["controlsPanel",""],[1,"relative","w-full","h-screen",3,"ngClass"],[1,"absolute","top-0","left-0","w-full","h-full","object-cover"],[1,"absolute","top-0","left-0","w-full","h-full"],[1,"absolute","top-4","left-4","z-10"],[1,"bg-opacity-75","p-2","rounded-full","mb-2",3,"click","ngClass"],["xmlns","http://www.w3.org/2000/svg","class","h-6 w-6","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngIf"],["class","bg-opacity-75 p-4 rounded-lg w-72",3,"ngClass",4,"ngIf"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 6h16M4 12h16M4 18h16"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M6 18L18 6M6 6l12 12"],[1,"bg-opacity-75","p-4","rounded-lg","w-72",3,"ngClass"],["routerLink","/",1,"flex","items-center","text-lg","font-bold","mb-4","w-full","text-left","p-2","rounded-lg","shadow-md",3,"ngClass"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","mr-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 19l-7-7 7-7"],[1,"mb-4"],[1,"flex","items-center","justify-between","mb-2"],[1,"block"],["title","A\xF1adir Punto Libre",1,"bg-green-500","hover:bg-green-700","text-white","font-bold","py-1","px-2","rounded","mr-2",3,"click"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-4","w-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],["class","p-2 rounded mb-1 cursor-pointer",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"my-4","border-gray-600"],["title","A\xF1adir par de PV en horizonte",1,"bg-indigo-500","hover:bg-indigo-700","text-white","font-bold","py-1","px-2","rounded",3,"click"],["title","A\xF1adir par de PV perpendicular",1,"bg-purple-500","hover:bg-purple-700","text-white","font-bold","py-1","px-2","rounded","mt-2",3,"click"],["for","horizonRotation",1,"block","mb-2"],["id","horizonRotation","type","range","min","-90","max","90",1,"w-full",3,"ngModelChange","ngModel"],["for","lines",1,"block","mb-2"],["id","lines","type","range","min","2","max","50",1,"w-full",3,"ngModelChange","ngModel"],[1,"mt-2","flex","justify-between"],[1,"w-1/2","bg-sky-500","hover:bg-sky-700","text-white","font-bold","py-2","px-4","rounded","mr-1",3,"click"],[1,"w-1/2","bg-teal-500","hover:bg-teal-700","text-white","font-bold","py-2","px-4","rounded","ml-1",3,"click"],[1,"text-md","font-bold","mb-2"],[1,"mb-2"],["for","aspectRatio",1,"block","mb-1"],["id","aspectRatio",1,"w-full","rounded","py-1","px-2",3,"ngModelChange","ngModel","ngClass"],[3,"value",4,"ngFor","ngForOf"],["class","flex items-center justify-between",4,"ngIf"],[1,"flex","mt-2","space-x-2"],["class","w-1/2 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded",3,"click",4,"ngIf"],["class","w-1/2 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded",3,"click",4,"ngIf"],[1,"w-full","bg-blue-500","hover:bg-blue-700","text-white","font-bold","py-2","px-4","rounded","mb-2",3,"click"],[1,"w-full","font-bold","py-2","px-4","rounded",3,"click","ngClass"],[1,"p-2","rounded","mb-1","cursor-pointer",3,"click","ngClass"],[1,"flex","items-center","justify-between"],[1,"flex","items-center"],["type","color",1,"w-8","h-8","mr-2",3,"ngModelChange","click","ngModel"],[1,"text-red-500","hover:text-red-700",3,"click"],["class","mt-2",4,"ngIf"],[1,"mt-2"],[4,"ngIf"],["type","checkbox",1,"mr-2",3,"ngModelChange","ngModel"],[1,"block","mb-2",3,"for"],["type","range","min","0","max","2","step","0.01",1,"w-full",3,"ngModelChange","id","ngModel"],[3,"value"],["type","number",1,"w-1/2","rounded","py-1","px-2","mr-1",3,"ngModelChange","ngModel","ngClass"],["type","number",1,"w-1/2","rounded","py-1","px-2","ml-1",3,"ngModelChange","ngModel","ngClass"],[1,"w-1/2","bg-green-500","hover:bg-green-700","text-white","font-bold","py-2","px-4","rounded",3,"click"],[1,"w-1/2","bg-blue-500","hover:bg-blue-700","text-white","font-bold","py-2","px-4","rounded",3,"click"]],template:function(t,n){if(t&1){let i=b();d(0,"div",4),V(1,"video",5,0)(3,"canvas",6,1),d(5,"div",7)(6,"button",8,2),y("click",function(){return u(i),x(n.gridControlsCollapsed=!n.gridControlsCollapsed)}),C(8,wt,2,0,"svg",9)(9,Ct,2,0,"svg",9),m(),C(10,Rt,50,32,"div",10),m()()}t&2&&(f("ngClass",k(7,vt,n.theme==="dark",n.theme==="light")),g(),W("hidden",!n.showCamera),g(5),f("ngClass",k(10,gt,n.theme==="dark",n.theme==="light")),g(2),f("ngIf",n.gridControlsCollapsed),g(),f("ngIf",!n.gridControlsCollapsed),g(),f("ngIf",!n.gridControlsCollapsed))},dependencies:[$,J,Z,K,dt,ct,ht,nt,rt,at,it,lt,st,ot,et],styles:[".panning[_ngcontent-%COMP%]{cursor:grabbing}.dragging[_ngcontent-%COMP%]{cursor:move}"]})};export{mt as PerspectiveGridComponent};
