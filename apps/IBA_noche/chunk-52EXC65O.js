import{a as it,b as nt,c as st,d as ot,e as rt,f as at,g as lt,h as ct,i as dt,j as ht}from"./chunk-RAE3MU4N.js";import{$ as C,D as w,G as x,I as W,J as d,K as h,L as T,M as V,N as y,O as u,P as Y,Q as D,R as F,S as A,T as P,U as B,V as S,W as E,X as I,Y as M,aa as U,c as O,ja as J,ka as Z,l as p,la as K,m as f,n as R,o as X,pa as $,r as j,sa as tt,ta as et,u as q,v as z,w as g,y as H,z as Q}from"./chunk-5QHLOJZU.js";var ut=["videoElement"],pt=["canvasElement"],ft=["toggleButton"],xt=["controlsPanel"],vt=(c,e)=>({"bg-gray-900":c,"bg-gray-100":e}),gt=(c,e)=>({"bg-gray-800 text-white":c,"bg-white text-black shadow-lg":e}),Pt=(c,e)=>({"bg-gray-700 hover:bg-gray-600 text-white":c,"bg-gray-200 hover:bg-gray-300 text-black":e}),L=(c,e)=>({"bg-gray-700 border border-gray-600":c,"bg-gray-200 border border-gray-300":e}),yt=(c,e)=>({"bg-gray-600 hover:bg-gray-500":c,"bg-gray-300 hover:bg-gray-400":e}),_t=(c,e,t,i,n,s)=>({"bg-gray-600":c,"bg-gray-700":e,"bg-gray-800":t,"bg-blue-200":i,"bg-gray-200":n,"bg-white":s});function wt(c,e){c&1&&(R(),d(0,"svg",11),T(1,"path",12),h())}function Ct(c,e){c&1&&(R(),d(0,"svg",11),T(1,"path",13),h())}function bt(c,e){if(c&1){let t=V();d(0,"div")(1,"label",48)(2,"input",54),M("ngModelChange",function(n){p(t);let s=u(2).$implicit;return I(s.isAnchored,n)||(s.isAnchored=n),f(n)}),y("ngModelChange",function(){p(t);let n=u(2).$implicit,s=u(2);return f(s.toggleAnchor(n))}),h(),d(3,"span"),P(4,"Anclar al Horizonte"),h()()()}if(c&2){let t=u(2).$implicit;g(2),E("ngModel",t.isAnchored)}}function Et(c,e){if(c&1){let t=V();d(0,"div")(1,"div",18)(2,"label",55),P(3),h(),d(4,"input",56),M("ngModelChange",function(n){p(t);let s=u(2).$implicit;return I(s.curvature,n)||(s.curvature=n),f(n)}),h()()()}if(c&2){let t=u(2).$implicit;g(2),Y("for","curvature-",t.id,""),g(),S("Curvatura: ",t.curvature,""),g(),Y("id","curvature-",t.id,""),E("ngModel",t.curvature)}}function It(c,e){if(c&1&&(d(0,"div",52),w(1,bt,5,1,"div",53)(2,Et,5,6,"div",53),h()),c&2){let t=u().$implicit;g(),x("ngIf",t.pairId===null),g(),x("ngIf",t.pairId!==null)}}function Mt(c,e){if(c&1){let t=V();d(0,"div",46),y("click",function(){let n=p(t).$implicit,s=u(2);return f(s.selectPoint(n.id))}),d(1,"div",47)(2,"div",48)(3,"input",49),M("ngModelChange",function(n){let s=p(t).$implicit;return I(s.color,n)||(s.color=n),f(n)}),y("click",function(n){return p(t),f(n.stopPropagation())}),h(),d(4,"span"),P(5),h()(),d(6,"button",50),y("click",function(n){let s=p(t).$implicit;return u(2).removePerspectivePoint(s.id),f(n.stopPropagation())}),R(),d(7,"svg",22),T(8,"path",13),h()()(),w(9,It,3,2,"div",51),h()}if(c&2){let t=e.$implicit,i=e.index,n=u(2);x("ngClass",U(4,_t,n.selectedPointId===t.id&&n.theme==="dark",n.selectedPointId!==t.id&&n.selectedPointId!==null&&n.theme==="dark",n.selectedPointId===null&&n.theme==="dark",n.selectedPointId===t.id&&n.theme==="light",n.selectedPointId!==t.id&&n.selectedPointId!==null&&n.theme==="light",n.selectedPointId===null&&n.theme==="light")),g(3),E("ngModel",t.color),g(2),S("Punto ",i+1,""),g(4),x("ngIf",n.selectedPointId===t.id)}}function kt(c,e){if(c&1&&(d(0,"option",57),P(1),h()),c&2){let t=e.$implicit;x("value",t.value),g(),B(t.name)}}function Tt(c,e){if(c&1){let t=V();d(0,"div",47)(1,"input",58),M("ngModelChange",function(n){p(t);let s=u(2);return I(s.customAspectRatioWidth,n)||(s.customAspectRatioWidth=n),f(n)}),h(),d(2,"span"),P(3,":"),h(),d(4,"input",59),M("ngModelChange",function(n){p(t);let s=u(2);return I(s.customAspectRatioHeight,n)||(s.customAspectRatioHeight=n),f(n)}),h()()}if(c&2){let t=u(2);g(),E("ngModel",t.customAspectRatioWidth),x("ngClass",C(4,L,t.theme==="dark",t.theme==="light")),g(3),E("ngModel",t.customAspectRatioHeight),x("ngClass",C(7,L,t.theme==="dark",t.theme==="light"))}}function Vt(c,e){if(c&1&&(d(0,"option",57),P(1),h()),c&2){let t=e.$implicit;x("value",t.deviceId),g(),B(t.label)}}function St(c,e){if(c&1){let t=V();d(0,"div",18)(1,"label",60),P(2,"Seleccionar C\xE1mara"),h(),d(3,"select",61),y("change",function(n){p(t);let s=u(2);return f(s.onCameraChange(n))}),w(4,Vt,2,2,"option",39),h()()}if(c&2){let t=u(2);g(3),x("value",t.selectedDeviceId)("ngClass",C(3,L,t.theme==="dark",t.theme==="light")),g(),x("ngForOf",t.videoDevices)}}function Rt(c,e){if(c&1){let t=V();d(0,"div",14,3)(2,"button",15),R(),d(3,"svg",16),T(4,"path",17),h(),X(),d(5,"span"),P(6,"Men\xFA/Asistente de Perspectiva"),h()(),d(7,"div",18)(8,"div",19)(9,"label",20),P(10,"Puntos de Perspectiva"),h(),d(11,"div")(12,"button",21),y("click",function(){p(t);let n=u();return f(n.addPerspectivePoint())}),R(),d(13,"svg",22),T(14,"path",23),h()()()(),w(15,Mt,10,11,"div",24),X(),T(16,"hr",25),d(17,"button",26),y("click",function(){p(t);let n=u();return f(n.addHorizonVPPair())}),P(18," A\xF1adir par de PV en horizonte "),h(),d(19,"button",27),y("click",function(){p(t);let n=u();return f(n.addPerpendicularVPPair())}),P(20," A\xF1adir par de PV perpendicular "),h()(),d(21,"div",18)(22,"label",28),P(23),h(),d(24,"input",29),M("ngModelChange",function(n){p(t);let s=u();return I(s.horizonRotation,n)||(s.horizonRotation=n),f(n)}),h()(),d(25,"div",18)(26,"label",30),P(27),h(),d(28,"input",31),M("ngModelChange",function(n){p(t);let s=u();return I(s.lineCount,n)||(s.lineCount=n),f(n)}),h(),d(29,"div",32)(30,"button",33),y("click",function(){p(t);let n=u();return f(n.toggleParallelLines())}),P(31," Paralelas "),h(),d(32,"button",34),y("click",function(){p(t);let n=u();return f(n.togglePerpendicularLines())}),P(33," Perpendiculares "),h()()(),d(34,"div",18)(35,"h4",35),P(36,"Superposici\xF3n de Marco"),h(),d(37,"div",36)(38,"label",37),P(39,"Relaci\xF3n de Aspecto"),h(),d(40,"select",38),M("ngModelChange",function(n){p(t);let s=u();return I(s.selectedAspectRatio,n)||(s.selectedAspectRatio=n),f(n)}),y("ngModelChange",function(){p(t);let n=u();return f(n.onAspectRatioChange())}),w(41,kt,2,2,"option",39),h()(),w(42,Tt,5,10,"div",40),d(43,"div",41)(44,"button",42),y("click",function(){p(t);let n=u();return f(n.recordFrame())}),P(45),h()()(),w(46,St,5,6,"div",43),d(47,"button",44),y("click",function(){p(t);let n=u();return f(n.toggleCamera())}),P(48),h(),d(49,"button",45),y("click",function(){p(t);let n=u();return f(n.toggleTheme())}),P(50),h()()}if(c&2){let t=u();x("ngClass",C(20,gt,t.theme==="dark",t.theme==="light")),g(2),x("ngClass",C(23,Pt,t.theme==="dark",t.theme==="light")),g(13),x("ngForOf",t.vanishingPoints),g(8),S("Rotaci\xF3n del Horizonte: ",t.horizonRotation,"\xB0"),g(),E("ngModel",t.horizonRotation),g(3),S("Cantidad de L\xEDneas: ",t.lineCount,""),g(),E("ngModel",t.lineCount),g(2),W("bg-sky-700",t.drawParallel),g(2),W("bg-teal-700",t.drawPerpendicular),g(8),E("ngModel",t.selectedAspectRatio),x("ngClass",C(26,L,t.theme==="dark",t.theme==="light")),g(),x("ngForOf",t.aspectRatios),g(),x("ngIf",t.selectedAspectRatio==="custom"),g(3),S(" ",t.selectedAspectRatio!=="none"?"Grabar Marco":"Grabar Pantalla"," "),g(),x("ngIf",t.videoDevices.length>1),g(2),S(" ",t.showCamera?"Ocultar":"Mostrar"," C\xE1mara "),g(),x("ngClass",C(29,yt,t.theme==="dark",t.theme==="light")),g(),S(" Cambiar a Tema ",t.theme==="dark"?"Claro":"Oscuro"," ")}}var mt=class c{constructor(e,t){this.elementRef=e;this.router=t}gridControlsCollapsed=!1;theme="dark";videoElement;canvasElement;toggleButton;controlsPanel;_horizonLevel=0;_horizonRotation=0;lineCount=10;showCamera=!0;drawParallel=!1;drawPerpendicular=!1;aspectRatios=[{name:"None",value:"none"},{name:"1:1",value:"1/1"},{name:"16:9",value:"16/9"},{name:"9:16",value:"9/16"},{name:"4:3",value:"4/3"},{name:"3:2",value:"3/2"},{name:"Custom",value:"custom"}];selectedAspectRatio="none";customAspectRatioWidth=16;customAspectRatioHeight=9;scale=1;panX=0;panY=0;isPanning=!1;lastPanPosition={x:0,y:0};initialPinchDistance=0;isDraggingFrame=!1;lastFrameDragPosition={x:0,y:0};videoDevices=[];selectedDeviceId="";get horizonRotation(){return this._horizonRotation}set horizonRotation(e){this._horizonRotation!==e&&(this._horizonRotation=e,this.updateConstrainedPointsPosition())}ctx;videoStream;vanishingPoints=[];framePoints=[];draggingPointIndex=-1;draggingFramePointIndex=-1;nextPointId=0;nextPairId=0;selectedPointId=null;ngAfterViewInit(){let e=this.canvasElement.nativeElement;this.ctx=e.getContext("2d"),this.setupCanvas(),this.getVideoDevices().then(()=>{this.startCamera()}),this.initVanishingPoints(),this.initFramePoints(),this.draw(),e.addEventListener("mousedown",this.onMouseDown.bind(this)),e.addEventListener("mousemove",this.onMouseMove.bind(this)),e.addEventListener("mouseup",this.onMouseUp.bind(this)),e.addEventListener("wheel",this.onWheel.bind(this)),e.addEventListener("touchstart",this.onTouchStart.bind(this)),e.addEventListener("touchmove",this.onTouchMove.bind(this)),e.addEventListener("touchend",this.onTouchEnd.bind(this))}onDocumentClick(e){if(this.gridControlsCollapsed)return;let t=e.target;this.toggleButton?.nativeElement.contains(t)||this.controlsPanel&&!this.controlsPanel.nativeElement.contains(t)&&(this.gridControlsCollapsed=!0)}onDocumentTouch(e){if(this.gridControlsCollapsed)return;let t=e.target;this.toggleButton?.nativeElement.contains(t)||this.controlsPanel&&!this.controlsPanel.nativeElement.contains(t)&&(this.gridControlsCollapsed=!0)}onResize(){this.setupCanvas()}screenToWorld(e,t){return{x:(e-this.panX)/this.scale,y:(t-this.panY)/this.scale}}setupCanvas(){let e=this.canvasElement.nativeElement;e.width=e.offsetWidth,e.height=e.offsetHeight,this._horizonLevel=e.height/2,this.panX=e.width/2,this.panY=this._horizonLevel}getVideoDevices(){return O(this,null,function*(){if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices)try{let e=yield navigator.mediaDevices.enumerateDevices();if(this.videoDevices=e.filter(t=>t.kind==="videoinput"),this.videoDevices.length>0){let t=this.videoDevices.find(i=>i.label.toLowerCase().includes("back")||i.label.toLowerCase().includes("rear"));t?this.selectedDeviceId=t.deviceId:this.selectedDeviceId=this.videoDevices[0].deviceId}}catch(e){console.error("Error enumerating devices: ",e)}})}startCamera(e){return O(this,null,function*(){if(this.videoStream&&this.videoStream.getTracks().forEach(t=>t.stop()),navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{let t={video:{}};if(e?t.video.deviceId={exact:e}:t.video.facingMode="environment",this.videoStream=yield navigator.mediaDevices.getUserMedia(t),this.videoElement.nativeElement.srcObject=this.videoStream,this.videoElement.nativeElement.play(),!e){let n=this.videoStream.getVideoTracks()[0].getSettings();n.deviceId&&(this.selectedDeviceId=n.deviceId,this.videoDevices.find(a=>a.deviceId===this.selectedDeviceId)||(yield this.getVideoDevices()))}}catch(t){if(console.error("Error accessing camera: ",t),t.name==="OverconstrainedError"||t.name==="NotFoundError")try{let i={video:!0};this.videoStream=yield navigator.mediaDevices.getUserMedia(i),this.videoElement.nativeElement.srcObject=this.videoStream,this.videoElement.nativeElement.play();let s=this.videoStream.getVideoTracks()[0].getSettings();s.deviceId&&(this.selectedDeviceId=s.deviceId)}catch(i){console.error("Error accessing fallback camera: ",i),this.showCamera=!1}else this.showCamera=!1}})}onCameraChange(e){let t=e.target.value;this.selectedDeviceId=t,this.startCamera(t)}initVanishingPoints(){if(this.vanishingPoints.length===0){let e={id:this.nextPointId++,x:0,y:0,color:this.getRandomColor(),isAnchored:!0,initialXOffset:0,pairId:null,curvature:.5};this.vanishingPoints.push(e),this.selectPoint(e.id)}}initFramePoints(){let{width:e,height:t}=this.canvasElement.nativeElement,i=this.screenToWorld(e/2,t/2),n=e/2/this.scale,s=t/2/this.scale;this.framePoints=[{x:i.x-n/2,y:i.y-s/2},{x:i.x+n/2,y:i.y-s/2},{x:i.x+n/2,y:i.y+s/2},{x:i.x-n/2,y:i.y+s/2}]}getRandomColor(){let e="0123456789ABCDEF",t="#";for(let i=0;i<6;i++)t+=e[Math.floor(Math.random()*16)];return t}addPerspectivePoint(){let{width:e,height:t}=this.canvasElement.nativeElement,i=this.screenToWorld(e/2,t/2),n={id:this.nextPointId++,x:i.x,y:i.y,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:null,curvature:.5};this.vanishingPoints.push(n),this.selectPoint(n.id)}addHorizonVPPair(){let{width:e}=this.canvasElement.nativeElement,t=this.nextPairId++,i={x:0,y:0},n=-e*.25,s=e*.25,a={id:this.nextPointId++,x:i.x+n,y:i.y,color:this.getRandomColor(),isAnchored:!0,initialXOffset:n,pairId:t,curvature:.5},r={id:this.nextPointId++,x:i.x+s,y:i.y,color:this.getRandomColor(),isAnchored:!0,initialXOffset:s,pairId:t,curvature:.5};this.vanishingPoints.push(a,r),this.updateConstrainedPointsPosition(),this.selectPoint(a.id)}addPerpendicularVPPair(){let e=this.nextPairId++,t={x:0,y:0},i=-200,n=200,s={id:this.nextPointId++,x:t.x,y:t.y+i,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:e,curvature:.5,isPerpendicular:!0,perpendicularOffset:i},a={id:this.nextPointId++,x:t.x,y:t.y+n,color:this.getRandomColor(),isAnchored:!1,initialXOffset:null,pairId:e,curvature:.5,isPerpendicular:!0,perpendicularOffset:n};this.vanishingPoints.push(s,a),this.updateConstrainedPointsPosition(),this.selectPoint(s.id)}removePerspectivePoint(e){let t=this.vanishingPoints.find(i=>i.id===e);t&&(t.pairId!==null?this.vanishingPoints=this.vanishingPoints.filter(i=>i.pairId!==t.pairId):this.vanishingPoints=this.vanishingPoints.filter(i=>i.id!==e),(this.selectedPointId===e||t.pairId!==null&&this.vanishingPoints.every(i=>i.pairId!==t.pairId))&&(this.selectedPointId=null))}onAspectRatioChange(){if(this.selectedAspectRatio==="none"){this.framePoints=[];return}let e;if(this.selectedAspectRatio==="custom")if(this.customAspectRatioWidth>0&&this.customAspectRatioHeight>0)e=this.customAspectRatioWidth/this.customAspectRatioHeight;else return;else{let r=this.selectedAspectRatio.split("/").map(Number);e=r[0]/r[1]}let{width:t,height:i}=this.canvasElement.nativeElement,n=this.screenToWorld(t/2,i/2),s=300/this.scale,a=s/e;this.framePoints=[{x:n.x-s/2,y:n.y-a/2},{x:n.x+s/2,y:n.y-a/2},{x:n.x+s/2,y:n.y+a/2},{x:n.x-s/2,y:n.y+a/2}]}selectPoint(e){this.selectedPointId===e?this.selectedPointId=null:this.selectedPointId=e}toggleAnchor(e){let t={x:0,y:0};e.isAnchored?(e.initialXOffset=e.x-t.x,this.updateConstrainedPointsPosition()):e.initialXOffset=null}updateConstrainedPointsPosition(){let e={x:0,y:0},t=this.horizonRotation*Math.PI/180;this.vanishingPoints.forEach(i=>{i.isAnchored&&i.initialXOffset!==null?(i.x=e.x+i.initialXOffset*Math.cos(t),i.y=e.y+i.initialXOffset*Math.sin(t)):i.isPerpendicular&&i.perpendicularOffset!=null&&(i.x=e.x+i.perpendicularOffset*Math.sin(t),i.y=e.y-i.perpendicularOffset*Math.cos(t))})}draw(){requestAnimationFrame(()=>this.draw());let e=this.canvasElement.nativeElement,{width:t,height:i}=e;this.ctx.clearRect(0,0,t,i),this.showCamera&&this.videoElement.nativeElement.readyState===4&&this.ctx.drawImage(this.videoElement.nativeElement,0,0,t,i),this.ctx.save(),this.ctx.translate(this.panX,this.panY),this.ctx.scale(this.scale,this.scale),this.drawGrid(),this.drawVanishingPoints(),this.drawPerspectiveFrame(),this.ctx.restore(),this.drawFrameOverlay()}drawPerspectiveFrame(){if(!(this.selectedAspectRatio==="none"||this.framePoints.length!==4)){this.ctx.strokeStyle="rgba(255, 255, 255, 0.8)",this.ctx.lineWidth=2/this.scale,this.ctx.beginPath(),this.ctx.moveTo(this.framePoints[0].x,this.framePoints[0].y);for(let e=1;e<=this.framePoints.length;e++)this.ctx.lineTo(this.framePoints[e%this.framePoints.length].x,this.framePoints[e%this.framePoints.length].y);this.ctx.stroke(),this.framePoints.forEach(e=>{this.ctx.fillStyle="white",this.ctx.beginPath(),this.ctx.arc(e.x,e.y,8/this.scale,0,Math.PI*2),this.ctx.fill()})}}drawFrameOverlay(){if(this.selectedAspectRatio==="none"||this.framePoints.length!==4)return;let e=this.canvasElement.nativeElement,{width:t,height:i}=e,n=this.framePoints.map(s=>({x:s.x*this.scale+this.panX,y:s.y*this.scale+this.panY}));this.ctx.save(),this.ctx.fillStyle="rgba(0, 0, 0, 0.5)",this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(t,0),this.ctx.lineTo(t,i),this.ctx.lineTo(0,i),this.ctx.closePath(),this.ctx.moveTo(n[0].x,n[0].y);for(let s=1;s<n.length;s++)this.ctx.lineTo(n[s].x,n[s].y);this.ctx.closePath(),this.ctx.fill("evenodd"),this.ctx.restore()}isPointInFrame(e){if(this.framePoints.length!==4)return!1;let t=this.framePoints[0],i=this.framePoints[1],n=this.framePoints[2],s=this.framePoints[3],a=(i.x-t.x)*(e.y-t.y)-(i.y-t.y)*(e.x-t.x),r=(n.x-i.x)*(e.y-i.y)-(n.y-i.y)*(e.x-i.x),l=(s.x-n.x)*(e.y-n.y)-(s.y-n.y)*(e.x-n.x),o=(t.x-s.x)*(e.y-s.y)-(t.y-s.y)*(e.x-s.x),m=a<0||r<0||l<0||o<0,_=a>0||r>0||l>0||o>0;return!(m&&_)}getFrameImageDataUrl(){if(this.framePoints.length!==4)return null;let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return console.error("Could not create output canvas context"),null;let i=this.framePoints.map(v=>({x:v.x*this.scale+this.panX,y:v.y*this.scale+this.panY})),n=i.map(v=>v.x),s=i.map(v=>v.y),a=Math.min(...n),r=Math.min(...s),l=Math.max(...n),o=Math.max(...s),m=l-a,_=o-r;e.width=m,e.height=_,t.beginPath(),t.moveTo(i[0].x-a,i[0].y-r);for(let v=1;v<i.length;v++)t.lineTo(i[v].x-a,i[v].y-r);return t.closePath(),t.clip(),t.drawImage(this.canvasElement.nativeElement,-a,-r),e.toDataURL("image/png")}recordFrame(){let e;if(this.selectedAspectRatio!=="none"?e=this.getFrameImageDataUrl():e=this.canvasElement.nativeElement.toDataURL("image/png"),e){let t=document.createElement("a");t.href=e,t.download="perspective-drawing.png",document.body.appendChild(t),t.click(),document.body.removeChild(t)}}drawGrid(){let{width:e,height:t}=this.canvasElement.nativeElement,i=this.horizonRotation*Math.PI/180;this.ctx.save(),this.ctx.strokeStyle="#FFFF00",this.ctx.lineWidth=2/this.scale,this.ctx.rotate(i),this.ctx.beginPath();let n=e/this.scale;this.ctx.moveTo(-n*4,0),this.ctx.lineTo(n*4,0),this.ctx.stroke(),this.ctx.restore(),this.drawParallel&&this.drawParallelLines(),this.drawPerpendicular&&this.drawPerpendicularLines();let s=this.vanishingPoints.filter(o=>o.pairId===null),a=this.vanishingPoints.filter(o=>o.pairId!==null),r=new Map;a.forEach(o=>{o.isPerpendicular&&(r.has(o.pairId)||r.set(o.pairId,[]),r.get(o.pairId).push(o))}),r.forEach(o=>{if(o.length===2){this.ctx.save(),this.ctx.strokeStyle="#FF00FF",this.ctx.lineWidth=1/this.scale,this.ctx.globalAlpha=.5,this.ctx.rotate(i),this.ctx.beginPath();let m=t/this.scale;this.ctx.moveTo(0,-m*4),this.ctx.lineTo(0,m*4),this.ctx.stroke(),this.ctx.restore()}}),s.forEach(o=>{this.drawLinesToPoint(o)});let l=new Map;a.forEach(o=>{l.has(o.pairId)||l.set(o.pairId,[]),l.get(o.pairId).push(o)}),l.forEach(o=>{o.length===2&&this.drawGeodesicGrid(o[0],o[1])})}drawLinesToPoint(e){let{width:t,height:i}=this.canvasElement.nativeElement;this.ctx.strokeStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id?"gray":e.color,this.ctx.lineWidth=1/this.scale;let n=this.screenToWorld(0,0),s=this.screenToWorld(t,0),a=this.screenToWorld(0,i),r=this.screenToWorld(t,i),l=this.lineCount;for(let o=0;o<=l;o++){let m=n.x+(s.x-n.x)*(o/l);this.ctx.beginPath(),this.ctx.moveTo(m,n.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}for(let o=0;o<=l;o++){let m=a.x+(r.x-a.x)*(o/l);this.ctx.beginPath(),this.ctx.moveTo(m,a.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}for(let o=0;o<=l;o++){let m=n.y+(a.y-n.y)*(o/l);this.ctx.beginPath(),this.ctx.moveTo(n.x,m),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}for(let o=0;o<=l;o++){let m=s.y+(r.y-s.y)*(o/l);this.ctx.beginPath(),this.ctx.moveTo(s.x,m),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}}drawGeodesicGrid(e,t){this.ctx.strokeStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id&&this.selectedPointId!==t.id?"gray":e.color,this.ctx.lineWidth=1/this.scale;let i=t.x-e.x,n=t.y-e.y,s=Math.sqrt(i*i+n*n),a=-n/s,r=i/s;for(let l=0;l<=this.lineCount;l++){let o=(l-this.lineCount/2)/(this.lineCount/2),m=e.curvature*s*.5,_=e.x+i*.25+a*m*o,v=e.y+n*.25+r*m*o,k=e.x+i*.75+a*m*o,b=e.y+n*.75+r*m*o;this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.bezierCurveTo(_,v,k,b,t.x,t.y),this.ctx.stroke()}}drawVanishingPoints(){this.vanishingPoints.forEach(e=>{this.ctx.fillStyle=this.selectedPointId!==null&&this.selectedPointId!==e.id?"gray":e.color,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,10/this.scale,0,Math.PI*2),this.ctx.fill(),this.selectedPointId===e.id&&(this.ctx.strokeStyle="white",this.ctx.lineWidth=2/this.scale,this.ctx.stroke())})}onMouseDown(e){if(e.button===1){this.isPanning=!0,this.lastPanPosition={x:e.clientX,y:e.clientY},this.canvasElement.nativeElement.classList.add("panning"),e.preventDefault();return}let t=this.screenToWorld(e.offsetX,e.offsetY);if(this.selectedAspectRatio!=="none"){for(let i=0;i<this.framePoints.length;i++){let n=this.framePoints[i];if(Math.sqrt(Math.pow(n.x-t.x,2)+Math.pow(n.y-t.y,2))<10/this.scale){this.draggingFramePointIndex=i,this.canvasElement.nativeElement.classList.add("dragging");return}}if(this.isPointInFrame(t)){this.isDraggingFrame=!0,this.lastFrameDragPosition=t,this.canvasElement.nativeElement.classList.add("dragging");return}}this.vanishingPoints.forEach((i,n)=>{Math.sqrt(Math.pow(i.x-t.x,2)+Math.pow(i.y-t.y,2))<10/this.scale&&(this.draggingPointIndex=n,this.selectPoint(i.id),this.canvasElement.nativeElement.classList.add("dragging"))})}onMouseMove(e){if(this.isPanning){let t=e.clientX-this.lastPanPosition.x,i=e.clientY-this.lastPanPosition.y;this.panX+=t,this.panY+=i,this.lastPanPosition={x:e.clientX,y:e.clientY};return}if(this.isDraggingFrame){let t=this.screenToWorld(e.offsetX,e.offsetY),i=t.x-this.lastFrameDragPosition.x,n=t.y-this.lastFrameDragPosition.y;this.framePoints.forEach(s=>{s.x+=i,s.y+=n}),this.lastFrameDragPosition=t;return}if(this.draggingFramePointIndex>-1){let t=this.screenToWorld(e.offsetX,e.offsetY);if(this.framePoints.length===4){let i={x:(this.framePoints[0].x+this.framePoints[1].x+this.framePoints[2].x+this.framePoints[3].x)/4,y:(this.framePoints[0].y+this.framePoints[1].y+this.framePoints[2].y+this.framePoints[3].y)/4},n=this.framePoints[this.draggingFramePointIndex],s={x:n.x-i.x,y:n.y-i.y},a={x:t.x-i.x,y:t.y-i.y},r=Math.sqrt(s.x*s.x+s.y*s.y),l=Math.sqrt(a.x*a.x+a.y*a.y);if(r>0){let o=l/r,m=JSON.parse(JSON.stringify(this.framePoints));this.framePoints.forEach((_,v)=>{let k={x:m[v].x-i.x,y:m[v].y-i.y};this.framePoints[v]={x:i.x+k.x*o,y:i.y+k.y*o}})}}return}if(this.draggingPointIndex>-1){let t=this.screenToWorld(e.offsetX,e.offsetY),i=this.vanishingPoints[this.draggingPointIndex];if(i.isAnchored&&i.initialXOffset!==null){let n=this.horizonRotation*Math.PI/180,s={x:0,y:0},a=t.x-s.x,r=t.y-s.y;i.initialXOffset=a*Math.cos(-n)-r*Math.sin(-n),this.updateConstrainedPointsPosition()}else if(i.isPerpendicular&&i.perpendicularOffset!=null){let n=this.horizonRotation*Math.PI/180,s={x:0,y:0},a=t.x-s.x,l=(t.y-s.y)*Math.cos(n)-a*Math.sin(n);i.perpendicularOffset=-l,this.vanishingPoints.filter(m=>m.pairId===i.pairId).forEach(m=>{m.id!==i.id&&(m.perpendicularOffset=-i.perpendicularOffset)}),this.updateConstrainedPointsPosition()}else i.x=t.x,i.y=t.y}}onMouseUp(e){this.draggingPointIndex=-1,this.draggingFramePointIndex=-1,this.isDraggingFrame=!1,this.isPanning=!1,this.canvasElement.nativeElement.classList.remove("dragging","panning")}onWheel(e){e.preventDefault();let t=1.1,i={x:e.offsetX,y:e.offsetY},n=this.screenToWorld(i.x,i.y);e.deltaY<0?this.scale*=t:this.scale/=t,this.scale=Math.max(.1,Math.min(this.scale,20));let s=this.screenToWorld(i.x,i.y);this.panX+=(s.x-n.x)*this.scale,this.panY+=(s.y-n.y)*this.scale}getDistance(e){let t=e[0].clientX-e[1].clientX,i=e[0].clientY-e[1].clientY;return Math.sqrt(t*t+i*i)}onTouchStart(e){if(e.touches.length===1){let t=e.touches[0],i=this.canvasElement.nativeElement.getBoundingClientRect(),n=t.clientX-i.left,s=t.clientY-i.top,a=this.screenToWorld(n,s);if(this.selectedAspectRatio!=="none"){for(let l=0;l<this.framePoints.length;l++){let o=this.framePoints[l];if(Math.sqrt(Math.pow(o.x-a.x,2)+Math.pow(o.y-a.y,2))<20/this.scale){this.draggingFramePointIndex=l,this.canvasElement.nativeElement.classList.add("dragging"),e.preventDefault();return}}if(this.isPointInFrame(a)){this.isDraggingFrame=!0,this.lastFrameDragPosition=a,this.canvasElement.nativeElement.classList.add("dragging"),e.preventDefault();return}}let r=!1;this.vanishingPoints.forEach((l,o)=>{Math.sqrt(Math.pow(l.x-a.x,2)+Math.pow(l.y-a.y,2))<20/this.scale&&(this.draggingPointIndex=o,this.selectPoint(l.id),this.canvasElement.nativeElement.classList.add("dragging"),r=!0)}),r||(this.isPanning=!0,this.lastPanPosition={x:t.clientX,y:t.clientY},this.canvasElement.nativeElement.classList.add("panning")),e.preventDefault()}else e.touches.length===2&&(this.isPanning=!1,this.initialPinchDistance=this.getDistance(e.touches))}onTouchMove(e){if(e.touches.length===1){let t=e.touches[0],i=this.canvasElement.nativeElement.getBoundingClientRect(),n=t.clientX-i.left,s=t.clientY-i.top,a=this.screenToWorld(n,s);if(this.isPanning){let r=t.clientX-this.lastPanPosition.x,l=t.clientY-this.lastPanPosition.y;this.panX+=r,this.panY+=l,this.lastPanPosition={x:t.clientX,y:t.clientY};return}if(this.isDraggingFrame){let r=a.x-this.lastFrameDragPosition.x,l=a.y-this.lastFrameDragPosition.y;this.framePoints.forEach(o=>{o.x+=r,o.y+=l}),this.lastFrameDragPosition=a;return}if(this.draggingFramePointIndex>-1){if(this.framePoints.length===4){let r={x:(this.framePoints[0].x+this.framePoints[1].x+this.framePoints[2].x+this.framePoints[3].x)/4,y:(this.framePoints[0].y+this.framePoints[1].y+this.framePoints[2].y+this.framePoints[3].y)/4},l=this.framePoints[this.draggingFramePointIndex],o={x:l.x-r.x,y:l.y-r.y},m={x:a.x-r.x,y:a.y-r.y},_=Math.sqrt(o.x*o.x+o.y*o.y),v=Math.sqrt(m.x*m.x+m.y*m.y);if(_>0){let k=v/_,b=JSON.parse(JSON.stringify(this.framePoints));this.framePoints.forEach((Dt,G)=>{let N={x:b[G].x-r.x,y:b[G].y-r.y};this.framePoints[G]={x:r.x+N.x*k,y:r.y+N.y*k}})}}return}if(this.draggingPointIndex>-1){let r=this.vanishingPoints[this.draggingPointIndex];if(r.isAnchored&&r.initialXOffset!==null){let l=this.horizonRotation*Math.PI/180,o={x:0,y:0},m=a.x-o.x,_=a.y-o.y;r.initialXOffset=m*Math.cos(-l)-_*Math.sin(-l),this.updateConstrainedPointsPosition()}else if(r.isPerpendicular&&r.perpendicularOffset!=null){let l=this.horizonRotation*Math.PI/180,o={x:0,y:0},m=a.x-o.x,v=(a.y-o.y)*Math.cos(l)-m*Math.sin(l);r.perpendicularOffset=-v,this.vanishingPoints.filter(b=>b.pairId===r.pairId).forEach(b=>{b.id!==r.id&&(b.perpendicularOffset=-r.perpendicularOffset)}),this.updateConstrainedPointsPosition()}else r.x=a.x,r.y=a.y}}else if(e.touches.length===2){let t=this.getDistance(e.touches),i=t/this.initialPinchDistance,n=this.canvasElement.nativeElement.getBoundingClientRect(),s={x:(e.touches[0].clientX+e.touches[1].clientX)/2-n.left,y:(e.touches[0].clientY+e.touches[1].clientY)/2-n.top},a=this.screenToWorld(s.x,s.y);this.scale*=i,this.scale=Math.max(.1,Math.min(this.scale,20));let r=this.screenToWorld(s.x,s.y);this.panX+=(r.x-a.x)*this.scale,this.panY+=(r.y-a.y)*this.scale,this.initialPinchDistance=t}e.preventDefault()}onTouchEnd(e){this.draggingPointIndex=-1,this.draggingFramePointIndex=-1,this.isDraggingFrame=!1,this.isPanning=!1,this.canvasElement.nativeElement.classList.remove("dragging","panning"),e.touches.length<2&&(this.initialPinchDistance=0)}toggleCamera(){this.showCamera=!this.showCamera}toggleTheme(){this.theme=this.theme==="light"?"dark":"light"}toggleParallelLines(){this.drawParallel=!this.drawParallel}togglePerpendicularLines(){this.drawPerpendicular=!this.drawPerpendicular}drawParallelLines(){let{width:e,height:t}=this.canvasElement.nativeElement,i=this.horizonRotation*Math.PI/180;this.ctx.save(),this.ctx.strokeStyle="#00FFFF",this.ctx.lineWidth=1/this.scale,this.ctx.rotate(i);let s=t/this.scale/this.lineCount,a=e/this.scale;for(let r=-this.lineCount;r<=this.lineCount;r++){if(r===0)continue;let l=r*s;this.ctx.beginPath(),this.ctx.moveTo(-a*4,l),this.ctx.lineTo(a*4,l),this.ctx.stroke()}this.ctx.restore()}drawPerpendicularLines(){let{width:e,height:t}=this.canvasElement.nativeElement,i=this.horizonRotation*Math.PI/180;this.ctx.save(),this.ctx.strokeStyle="#FF00FF",this.ctx.lineWidth=1/this.scale,this.ctx.rotate(i);let s=e/this.scale/this.lineCount,a=t/this.scale;for(let r=-this.lineCount;r<=this.lineCount;r++){let l=r*s;this.ctx.beginPath(),this.ctx.moveTo(l,-a*4),this.ctx.lineTo(l,a*4),this.ctx.stroke()}this.ctx.restore()}static \u0275fac=function(t){return new(t||c)(H(j),H(tt))};static \u0275cmp=Q({type:c,selectors:[["app-perspective-grid"]],viewQuery:function(t,i){if(t&1&&(D(ut,5),D(pt,5),D(ft,5),D(xt,5)),t&2){let n;F(n=A())&&(i.videoElement=n.first),F(n=A())&&(i.canvasElement=n.first),F(n=A())&&(i.toggleButton=n.first),F(n=A())&&(i.controlsPanel=n.first)}},hostBindings:function(t,i){t&1&&y("click",function(s){return i.onDocumentClick(s)},!1,z)("touchstart",function(s){return i.onDocumentTouch(s)},!1,z)("resize",function(){return i.onResize()},!1,q)},decls:11,vars:13,consts:[["videoElement",""],["canvasElement",""],["toggleButton",""],["controlsPanel",""],[1,"relative","w-full","h-screen",3,"ngClass"],[1,"absolute","top-0","left-0","w-full","h-full","object-cover"],[1,"absolute","top-0","left-0","w-full","h-full"],[1,"absolute","top-4","left-4","z-10"],[1,"bg-opacity-75","p-2","rounded-full","mb-2",3,"click","ngClass"],["xmlns","http://www.w3.org/2000/svg","class","h-6 w-6","fill","none","viewBox","0 0 24 24","stroke","currentColor",4,"ngIf"],["class","bg-opacity-75 p-4 rounded-lg w-72",3,"ngClass",4,"ngIf"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M4 6h16M4 12h16M4 18h16"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M6 18L18 6M6 6l12 12"],[1,"bg-opacity-75","p-4","rounded-lg","w-72",3,"ngClass"],["routerLink","/",1,"flex","items-center","text-lg","font-bold","mb-4","w-full","text-left","p-2","rounded-lg","shadow-md",3,"ngClass"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-6","w-6","mr-2"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M15 19l-7-7 7-7"],[1,"mb-4"],[1,"flex","items-center","justify-between","mb-2"],[1,"block"],["title","A\xF1adir Punto Libre",1,"bg-green-500","hover:bg-green-700","text-white","font-bold","py-1","px-2","rounded","mr-2",3,"click"],["xmlns","http://www.w3.org/2000/svg","fill","none","viewBox","0 0 24 24","stroke","currentColor",1,"h-4","w-4"],["stroke-linecap","round","stroke-linejoin","round","stroke-width","2","d","M12 4v16m8-8H4"],["class","p-2 rounded mb-1 cursor-pointer",3,"ngClass","click",4,"ngFor","ngForOf"],[1,"my-4","border-gray-600"],["title","A\xF1adir par de PV en horizonte",1,"bg-indigo-500","hover:bg-indigo-700","text-white","font-bold","py-1","px-2","rounded",3,"click"],["title","A\xF1adir par de PV perpendicular",1,"bg-purple-500","hover:bg-purple-700","text-white","font-bold","py-1","px-2","rounded","mt-2",3,"click"],["for","horizonRotation",1,"block","mb-2"],["id","horizonRotation","type","range","min","-90","max","90",1,"w-full",3,"ngModelChange","ngModel"],["for","lines",1,"block","mb-2"],["id","lines","type","range","min","2","max","50",1,"w-full",3,"ngModelChange","ngModel"],[1,"mt-2","flex","justify-between"],[1,"w-1/2","bg-sky-500","hover:bg-sky-700","text-white","font-bold","py-2","px-4","rounded","mr-1",3,"click"],[1,"w-1/2","bg-teal-500","hover:bg-teal-700","text-white","font-bold","py-2","px-4","rounded","ml-1",3,"click"],[1,"text-md","font-bold","mb-2"],[1,"mb-2"],["for","aspectRatio",1,"block","mb-1"],["id","aspectRatio",1,"w-full","rounded","py-1","px-2",3,"ngModelChange","ngModel","ngClass"],[3,"value",4,"ngFor","ngForOf"],["class","flex items-center justify-between",4,"ngIf"],[1,"flex","mt-2","space-x-2"],[1,"w-full","bg-green-500","hover:bg-green-700","text-white","font-bold","py-2","px-4","rounded",3,"click"],["class","mb-4",4,"ngIf"],[1,"w-full","bg-blue-500","hover:bg-blue-700","text-white","font-bold","py-2","px-4","rounded","mb-2",3,"click"],[1,"w-full","font-bold","py-2","px-4","rounded",3,"click","ngClass"],[1,"p-2","rounded","mb-1","cursor-pointer",3,"click","ngClass"],[1,"flex","items-center","justify-between"],[1,"flex","items-center"],["type","color",1,"w-8","h-8","mr-2",3,"ngModelChange","click","ngModel"],[1,"text-red-500","hover:text-red-700",3,"click"],["class","mt-2",4,"ngIf"],[1,"mt-2"],[4,"ngIf"],["type","checkbox",1,"mr-2",3,"ngModelChange","ngModel"],[1,"block","mb-2",3,"for"],["type","range","min","0","max","2","step","0.01",1,"w-full",3,"ngModelChange","id","ngModel"],[3,"value"],["type","number",1,"w-1/2","rounded","py-1","px-2","mr-1",3,"ngModelChange","ngModel","ngClass"],["type","number",1,"w-1/2","rounded","py-1","px-2","ml-1",3,"ngModelChange","ngModel","ngClass"],["for","cameraSelect",1,"block","mb-1"],["id","cameraSelect",1,"w-full","rounded","py-1","px-2",3,"change","value","ngClass"]],template:function(t,i){if(t&1){let n=V();d(0,"div",4),T(1,"video",5,0)(3,"canvas",6,1),d(5,"div",7)(6,"button",8,2),y("click",function(){return p(n),f(i.gridControlsCollapsed=!i.gridControlsCollapsed)}),w(8,wt,2,0,"svg",9)(9,Ct,2,0,"svg",9),h(),w(10,Rt,51,32,"div",10),h()()}t&2&&(x("ngClass",C(7,vt,i.theme==="dark",i.theme==="light")),g(),W("hidden",!i.showCamera),g(5),x("ngClass",C(10,gt,i.theme==="dark",i.theme==="light")),g(2),x("ngIf",i.gridControlsCollapsed),g(),x("ngIf",!i.gridControlsCollapsed),g(),x("ngIf",!i.gridControlsCollapsed))},dependencies:[$,J,Z,K,ht,ct,dt,nt,rt,at,it,lt,st,ot,et],styles:[".panning[_ngcontent-%COMP%]{cursor:grabbing}.dragging[_ngcontent-%COMP%]{cursor:move}"]})};export{mt as PerspectiveGridComponent};
